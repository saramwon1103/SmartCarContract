<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MORENT - Car Rental Platform</title>
  <link rel="stylesheet" href="../css/admin_dashboard.css">
  <link rel="stylesheet" href="../css/index.css">
  <link rel="stylesheet" href="../css/home.css">
  <link rel="stylesheet" href="../css/header.css">
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.6.0/css/all.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/dist/ethers.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/dist/ethers.umd.js"></script>
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar will be loaded by user_sidebar.js -->
    <!-- Main Section -->
    <main class="main">
      <header class="topbar">
        <div class="search">
          <input type="text" placeholder="Search for cars..." />
          <span class="filter"><img src="../image/search.svg" alt="Search icon" class="icon"></span>
        </div>
        <div class="user-icons">
          <!-- Wallet Status Display -->
          <div class="wallet-status" id="walletStatus">
            <div class="wallet-info" id="walletInfo" style="display: none;">
              <span class="wallet-balance" id="walletBalance">0.00 CPT</span>
              <span class="wallet-address" id="walletAddress">Not connected</span>
            </div>
            <button class="connect-wallet-btn" id="connectWalletBtn">
              <i class="fa-solid fa-wallet"></i>
              <span>Connect Wallet</span>
            </button>
          </div>
          <span><img src="../image/heart.svg" alt="Heart icon" class="icon"></span>
          <span><img src="../image/notification.svg" alt="Bell icon" class="icon"></span>
          <img src="https://i.pravatar.cc/40" alt="avatar" class="avatar" />
        </div>
      </header>
      <section class="content">
        <div class="left-panel left-panel-full">
          <div class="home-container">
            <!-- Hero Section -->
            <section class="hero-section">
              <!-- Left Hero Banner -->
              <div class="hero-left">
                <div class="hero-content">
                  <h1 class="hero-title">The Best Platform for Car Rental</h1>
                  <p class="hero-description">Ease of doing a car rental safely and reliably. Of course at a low price.</p>
                  <button class="rental-btn">Rental Car</button>
                </div>
                <div class="hero-car-image left-car"></div>
              </div>
              <!-- Right Hero Banner -->
              <div class="hero-right">
                <div class="hero-content">
                  <h2 class="hero-title">Easy way to rent a car at a low price</h2>
                  <p class="hero-description">Providing cheap car rental services and safe and comfortable facilities.</p>
                  <button class="rental-btn">Rental Car</button>
                </div>
                <div class="hero-car-image right-car"></div>
              </div>
            </section>

            <!-- Popular Car Section -->
            <section class="popular-section">
              <div class="section-header">
                <h3 class="section-title">Popular Car</h3>
                <a href="#" class="view-all">View All</a>
              </div>
              <div class="car-grid popular-grid">
                <!-- Dynamic Popular Cars -->
              </div>
            </section>

            <!-- Recommendation Car Section -->
            <section class="recommendation-section">
              <div class="section-header">
                <h3 class="section-title">Recommendation Car</h3>
              </div>
              <div class="car-grid">
                <!-- Dynamic Recommendation Cars -->
              </div>
              <div class="show-more-container">
                <button class="show-more-btn">Show more cars <i class="fa-solid fa-chevron-down"></i></button>
                <p class="total-cars">0 Cars</p>
              </div>
            </section>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Connect Wallet Modal -->
  <div class="wallet-modal-overlay" id="walletModalOverlay">
    <div class="wallet-modal">
      <div class="modal-header">
        <h2 class="modal-title">Connect Wallet</h2>
        <button class="modal-close" id="modalCloseBtn">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="wallet-list">
          <button class="wallet-option" data-wallet="metamask">
            <span class="wallet-name">MetaMask</span>
              <div class="wallet-icon metamask-icon">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                    <path d="M28 8L18 15L20 10L28 8Z" fill="#E17726"/>
                    <path d="M4 8L14 15L12 10L4 8Z" fill="#E27625"/>
                    <path d="M24 21L22 25L27 26L28 21H24Z" fill="#E27625"/>
                    <path d="M4 21L5 26L10 25L8 21H4Z" fill="#E27625"/>
                    <path d="M16 13L14 15L18 15L16 13Z" fill="#E27625"/>
                </svg>
            </div>
          </button>
          <button class="wallet-option" data-wallet="walletconnect">
            <span class="wallet-name">WalletConnect</span>
            <div class="wallet-icon walletconnect-icon">
              <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                  <rect width="32" height="32" rx="16" fill="#3B99FC"/>
                  <path d="M10 14C12.2 11.8 15.8 11.8 18 14L18.5 14.5C18.6 14.6 18.6 14.8 18.5 14.9L17.5 15.9C17.4 16 17.2 16 17.1 15.9L16.4 15.2C15 13.8 12.8 13.8 11.4 15.2L10.7 15.9C10.6 16 10.4 16 10.3 15.9L9.3 14.9C9.2 14.8 9.2 14.6 9.3 14.5L10 14ZM20.7 16.2L21.6 17.1C21.7 17.2 21.7 17.4 21.6 17.5L17.4 21.7C17.3 21.8 17.1 21.8 17 21.7L14 18.7C13.95 18.65 13.85 18.65 13.8 18.7L10.8 21.7C10.7 21.8 10.5 21.8 10.4 21.7L6.2 17.5C6.1 17.4 6.1 17.2 6.2 17.1L7.1 16.2C7.2 16.1 7.4 16.1 7.5 16.2L10.5 19.2C10.55 19.25 10.65 19.25 10.7 19.2L13.7 16.2C13.8 16.1 14 16.1 14.1 16.2L17.1 19.2C17.15 19.25 17.25 19.25 17.3 19.2L20.3 16.2C20.4 16.1 20.6 16.1 20.7 16.2Z" fill="white"/>
              </svg>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/auth.js"></script>
  <script src="../js/user_sidebar.js"></script>
  <script src="../js/wallet.js"></script>
  <script>

    // Load cars from API and render dynamically
    async function loadCars() {
      try {
        const response = await fetch('http://localhost:3000/api/cars');
        if (!response.ok) throw new Error('Failed to fetch cars');
        const cars = await response.json();

        const popularGrid = document.querySelector('.popular-grid');
        const recommendationGrid = document.querySelector('.recommendation-section .car-grid');
        const totalCarsElement = document.querySelector('.total-cars');

        popularGrid.innerHTML = '';
        recommendationGrid.innerHTML = '';
        totalCarsElement.textContent = `${cars.length} Cars`;

        // Render Popular Cars (first 4)
        cars.slice(0, 4).forEach(car => {
          popularGrid.appendChild(createCarCard(car));
        });

        // Render All Recommendation Cars
        cars.forEach(car => {
          recommendationGrid.appendChild(createCarCard(car));
        });

      } catch (error) {
        console.error('Error loading cars:', error);
      }
    }

    // Tạo card xe với data-car-id và xử lý click
    function createCarCard(car) {
      const div = document.createElement('div');
      div.className = 'car-card';
      div.dataset.carId = car.CarId; // Lưu CarId để dùng khi click
      div.style.cursor = 'pointer'; // Hiệu ứng bấm

      div.innerHTML = `
        <div class="card-header">
          <div>
            <h4 class="car-name">${car.CarName || 'Unknown Car'}</h4>
            <p class="car-category">${car.Brand || 'Unknown'}</p>
          </div>
          <button class="heart-icon" onclick="event.stopPropagation()">
            <i class="fa-regular fa-heart"></i>
          </button>
        </div>
        <div class="car-image-container">
          <img src="${car.ImageURL || 'https://via.placeholder.com/232x72'}" 
               alt="${car.CarName}" class="car-img" 
               onerror="this.src='https://via.placeholder.com/232x72'">
        </div>
        <div class="car-specs">
          <div class="spec-item"><i class="fa-solid fa-gas-pump"></i><span>80L</span></div>
          <div class="spec-item"><i class="fa-solid fa-circle-m"></i><span>Manual</span></div>
          <div class="spec-item"><i class="fa-solid fa-users"></i><span>4 People</span></div>
        </div>
        <div class="card-footer">
          <div class="pricing">
            <span class="current-price">${parseFloat(car.PriceRent || 0).toFixed(2)} CPT/<span class="day">day</span></span>
          </div>
          <button class="rent-btn" onclick="handleRentClick(event, '${car.CarId}')">Rent Now</button>
        </div>
      `;

      // Xử lý click vào card → chuyển sang car_detail.html?carId=C0001
      div.addEventListener('click', () => {
        window.location.href = `car_detail.html?carId=${car.CarId}`;
      });

      return div;
    }

    // Load khi trang sẵn sàng
    document.addEventListener('DOMContentLoaded', loadCars);
  </script>

  <!-- Wallet Integration Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/wallet-auth.js"></script>
  <script>
    // Wallet Management for Home Page
    class HomeWalletManager {
      constructor() {
        this.connectBtn = document.getElementById('connectWalletBtn');
        this.walletInfo = document.getElementById('walletInfo');
        this.walletBalance = document.getElementById('walletBalance');
        this.walletAddress = document.getElementById('walletAddress');
        
        this.init();
      }

      async init() {
        // Setup click handlers
        this.connectBtn.addEventListener('click', () => this.handleWalletConnect());
        
        // Load user and wallet status
        await this.loadUserWalletStatus();
        
        // Listen for MetaMask account changes
        if (window.ethereum) {
          window.ethereum.on('accountsChanged', () => this.handleAccountChange());
        }
      }

      async loadUserWalletStatus() {
        try {
          if (!walletAuth.isLoggedIn()) {
            this.showConnectButton('Please login first');
            return;
          }

          const user = walletAuth.getCurrentUser();
          const eligibility = await this.checkRentalEligibility(user.UserId);
          
          this.updateWalletDisplay(eligibility);
        } catch (error) {
          console.error('Error loading wallet status:', error);
          this.showConnectButton('Error loading wallet');
        }
      }

      async checkRentalEligibility(userId) {
        try {
          const response = await fetch(`http://localhost:3000/api/users/${userId}/rental-eligibility`);
          const data = await response.json();
          return data.success ? data.eligibility : null;
        } catch (error) {
          console.error('Error checking eligibility:', error);
          return null;
        }
      }

      updateWalletDisplay(eligibility) {
        if (!eligibility) {
          this.showConnectButton('Unable to check wallet status');
          return;
        }

        if (eligibility.hasWallet) {
          // Show wallet info
          const user = walletAuth.getCurrentUser();
          const shortAddress = user.WalletAddress ? 
            `${user.WalletAddress.slice(0, 6)}...${user.WalletAddress.slice(-4)}` : 'Unknown';
          
          this.walletBalance.textContent = `${eligibility.cptBalance.toFixed(2)} CPT`;
          this.walletAddress.textContent = shortAddress;
          
          this.walletInfo.style.display = 'block';
          this.connectBtn.style.display = 'none';
          
          // Add status class based on eligibility
          this.walletInfo.className = eligibility.eligible ? 'wallet-info connected' : 'wallet-info warning';
        } else {
          this.showConnectButton('Connect Wallet to Rent');
        }
      }

      showConnectButton(text) {
        this.connectBtn.style.display = 'block';
        this.connectBtn.querySelector('span').textContent = text;
        this.walletInfo.style.display = 'none';
      }

      async handleWalletConnect() {
        try {
          if (!walletAuth.isLoggedIn()) {
            alert('Please login first to connect your wallet');
            window.location.href = 'login.html';
            return;
          }

          this.connectBtn.disabled = true;
          this.connectBtn.querySelector('span').textContent = 'Connecting...';
          
          const result = await walletAuth.connectWallet();
          
          if (result.success) {
            await this.loadUserWalletStatus();
            
            // Show success message
            this.showNotification('Wallet connected successfully!', 'success');
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          console.error('Wallet connection error:', error);
          this.showNotification(`Failed to connect wallet: ${error.message}`, 'error');
        } finally {
          this.connectBtn.disabled = false;
        }
      }

      async handleAccountChange() {
        // Reload wallet status when MetaMask account changes
        await this.loadUserWalletStatus();
      }

      showNotification(message, type) {
        // Create simple notification
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          border-radius: 8px;
          color: white;
          font-weight: 500;
          z-index: 9999;
          background: ${type === 'success' ? '#28a745' : '#dc3545'};
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.remove();
        }, 3000);
      }
    }

    // Initialize wallet manager when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new HomeWalletManager();
    });

    // Override rent button behavior to check wallet eligibility
    window.handleRentClick = async function(event, carId) {
      event.stopPropagation();
      
      if (!walletAuth.isLoggedIn()) {
        alert('Please login to rent a car');
        window.location.href = 'login.html';
        return;
      }

      const user = walletAuth.getCurrentUser();
      const eligibility = await fetch(`http://localhost:3000/api/users/${user.UserId}/rental-eligibility`)
        .then(res => res.json())
        .then(data => data.eligibility)
        .catch(err => null);

      if (!eligibility) {
        alert('Unable to check rental eligibility. Please try again.');
        return;
      }

      if (!eligibility.hasWallet) {
        alert('Please connect your wallet first to rent a car');
        return;
      }

      if (eligibility.cptBalance === 0) {
        const proceed = confirm('You have no CPT balance. You will need to buy tokens to complete the rental. Continue?');
        if (!proceed) return;
      }

      // Proceed to rental form
      window.location.href = `rental_form.html?carId=${carId}`;
    };
  </script>

  <!-- Wallet Styles -->
  <style>
    .wallet-status {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .wallet-info {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      min-width: 150px;
    }

    .wallet-info.connected {
      background: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }

    .wallet-info.warning {
      background: #fff3cd;
      border-color: #ffeaa7;
      color: #856404;
    }

    .wallet-balance {
      display: block;
      font-weight: 600;
      font-size: 13px;
    }

    .wallet-address {
      display: block;
      color: #666;
      font-size: 11px;
    }

    .connect-wallet-btn {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.3s;
    }

    .connect-wallet-btn:hover {
      background: #0056b3;
    }

    .connect-wallet-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .notification {
      animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</body>
</html>