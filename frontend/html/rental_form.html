<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rental / Purchase Form | Morent</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../css/rental_form.css" />
  <style>
    .disabled-input {
      background-color: #f3f4f6 !important;
      color: #9ca3af !important;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }
    
    /* Signature Section Styles */
    #signature-section {
      border: 2px solid #007bff;
      border-radius: 10px;
      padding: 20px;
      background: #f8f9ff;
    }
    
    .signature-info h3 {
      color: #007bff;
      margin-bottom: 15px;
    }
    
    .signature-progress {
      margin: 20px 0;
    }
    
    .signature-step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid #e9ecef;
    }
    
    .step-icon {
      font-size: 20px;
      width: 30px;
      text-align: center;
    }
    
    .step-status {
      margin-left: auto;
      font-weight: 600;
      color: #666;
    }
    
    .step-status.signed {
      color: #28a745;
    }
    
    .step-status.pending {
      color: #ffc107;
    }
    
    .signature-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    
    .signature-actions .btn-wallet {
      flex: 1;
      min-width: 150px;
    }
  </style>
</head>

<body>
  <header>
    <div class="logo">MORENT</div>
    <div class="search-bar">
      <input type="text" placeholder="Search something here..." />
      <img src="../image/search.svg" alt="search" />
    </div>
    <div class="user-icons">
      <img src="../image/heart.svg" alt="heart">
      <img src="../image/notification.svg" alt="bell">
      <img src="../image/setting.svg" alt="setting">
      <img src="https://i.pravatar.cc/40" alt="avatar" class="avatar">
    </div>
  </header>

  <main>
    <h1>Rental / Purchase Form</h1>

    <!-- Loading -->
    <div id="loading" class="loading">Loading car information...</div>

    <!-- Form -->
    <form id="rentalForm" style="display: none;">
      <div class="form-row">
        <div>
          <label for="car-name">Car Name</label>
          <input type="text" id="car-name" readonly>
        </div>
        <div>
          <label for="contract-type">Contract Type</label>
          <select id="contract-type" required>
            <option value="">-- Select --</option>
            <option value="rental">Rental</option>
            <option value="purchase">Purchase</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="start-date">Start Date</label>
          <input type="date" id="start-date" required>
        </div>
        <div>
          <label for="end-date">End Date</label>
          <input type="date" id="end-date" required>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="start-time">Start Time</label>
          <input type="time" id="start-time" required>
        </div>
        <div>
          <label for="end-time">End Time</label>
          <input type="time" id="end-time" required>
        </div>
      </div>

      <!-- T√πy ch·ªçn thanh to√°n cho mua xe -->
      <div class="form-row" id="payment-options-row" style="display: none;">
        <div>
          <label for="payment-type">Payment Type</label>
          <select id="payment-type" required>
            <option value="">-- Select Payment Type --</option>
            <option value="full">Pay Full Amount</option>
            <option value="quarterly">Pay by Quarter</option>
          </select>
        </div>
        <div>
          <label for="quarters">Number of Quarters</label>
          <select id="quarters" disabled>
            <option value="4">4 Quarters (1 Year)</option>
            <option value="8">8 Quarters (2 Years)</option>
            <option value="12">12 Quarters (3 Years)</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="rental-amount" id="amount-label">Rental Amount (CPT)</label>
          <input type="number" id="rental-amount" readonly>
        </div>
        <div id="payment-amount-container" style="display: none;">
          <label for="payment-amount">Payment Amount (CPT)</label>
          <input type="number" id="payment-amount" readonly>
        </div>
      </div>

      <div>
        <label for="note">Additional Note</label>
        <textarea id="note" rows="4" placeholder="Enter special requests or remarks..."></textarea>
      </div>

      <button type="submit" class="btn-submit">Create Contract Request</button>
      
      <!-- Signature Section (Hidden initially) -->
      <div id="signature-section" style="display: none; margin-top: 20px;">
        <h3>üîê Digital Signature Required</h3>
        <div class="signature-info">
          <p><strong>Contract Address:</strong> <span id="contract-address-display">-</span></p>
          <p><strong>Status:</strong> <span id="contract-status">Pending Signatures</span></p>
          
          <div class="signature-progress">
            <div class="signature-step">
              <span class="step-icon" id="owner-sign-icon">‚è≥</span>
              <span>Car Owner Signature</span>
              <span class="step-status" id="owner-sign-status">Waiting...</span>
            </div>
            <div class="signature-step">
              <span class="step-icon" id="user-sign-icon">‚è≥</span>
              <span>Your Signature</span>
              <span class="step-status" id="user-sign-status">Waiting...</span>
            </div>
          </div>
          
          <div class="signature-actions">
            <button type="button" class="btn-wallet" id="sign-as-user-btn" disabled>
              Sign as User
            </button>
            <button type="button" class="btn-wallet" id="check-signatures-btn">
              Check Status
            </button>
            <button type="button" class="btn-wallet" id="simulate-owner-sign-btn">
              üß™ Simulate Owner Sign (Test)
            </button>
          </div>
        </div>
      </div>
    </form>
  </main>

  <footer>
    <div class="top">
      <div>
        <div class="logo">MORENT</div>
        <p class="desc">Our vision is to provide convenience and help increase your sales business.</p>
      </div>
      <div class="links">
        <div><h4>About</h4><a href="#">How it works</a><a href="#">Featured</a><a href="#">Partnership</a><a href="#">Business Relation</a></div>
        <div><h4>Community</h4><a href="#">Events</a><a href="#">Blog</a><a href="#">Podcast</a><a href="#">Invite a friend</a></div>
        <div><h4>Socials</h4><a href="#">Discord</a><a href="#">Instagram</a><a href="#">Twitter</a><a href="#">Facebook</a></div>
      </div>
    </div>
    <div class="bottom">
      <span>¬©2022 MORENT. All rights reserved</span>
      <div><a href="#">Privacy & Policy</a> | <a href="#">Terms & Condition</a></div>
    </div>
  </footer>

  <!-- ============= SCRIPT ‚Äì WALLET & CPT INTEGRATION ============= -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/dist/ethers.umd.js"></script>
  <script type="module">
    import { AuthManager } from '../js/auth.js';
    window.AuthManager = AuthManager;
  </script>
  <script>
    const CPT_TOKEN_PRICE = 0.000287; // ETH per CPT token (287000000000000 wei)
    const CONTRACT_ADDRESSES = {
      CPT_TOKEN: '0x5FbDB2315678afecb367f032d93F642f64180aa3', // Hardhat local deployed CPT token
      FACTORY: '0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512'     // Hardhat local deployed Factory
    };
    
    const API_BASE_URL = 'http://localhost:3000/api';

    let provider = null;
    let currentAccount = null;
    let cptContract = null;
    let carData = null;

  (function () {
    const urlParams = new URLSearchParams(window.location.search);
    const carId = urlParams.get('carId');
    const loadingEl = document.getElementById('loading');
    const formEl = document.getElementById('rentalForm');

    // Check authentication first
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    if (!isLoggedIn) {
      loadingEl.textContent = 'Please login to rent a car';
      loadingEl.style.color = 'red';
      setTimeout(() => {
        window.location.href = 'login.html';
      }, 2000);
      return;
    }

    if (!carId) {
      loadingEl.textContent = 'Error: No car selected!';
      loadingEl.style.color = 'red';
      return;
    }

    console.log('Loading car data for ID:', carId);

    // Try different API endpoints for car data
    console.log('Fetching car data from APIs...');
    Promise.all([
      fetch(`http://localhost:3000/api/admin/cars/${carId}`)
        .then(res => {
          console.log('Single car API response status:', res.status);
          return res.json();
        })
        .catch(err => {
          console.error('Single car API error:', err);
          return { success: false, error: err.message };
        }),
      fetch(`http://localhost:3000/api/cars`)
        .then(res => {
          console.log('All cars API response status:', res.status);
          return res.json();
        })
        .catch(err => {
          console.error('All cars API error:', err);
          return [];
        })
    ])
    .then(([singleCarResponse, allCarsResponse]) => {
      let car = null;
      
      // Try to get from single car endpoint (admin format)
      if (singleCarResponse.success && singleCarResponse.car) {
        car = singleCarResponse.car;
        console.log('Car data from single endpoint:', car);
      } 
      // Fallback to search in all cars (public format - direct array)
      else if (Array.isArray(allCarsResponse)) {
        car = allCarsResponse.find(c => c.CarId === carId);
        console.log('Car data from public cars endpoint:', car);
        console.log('Available cars:', allCarsResponse.map(c => c.CarId));
      }
      
      if (!car) {
        throw new Error(`Car with ID ${carId} not found`);
      }
      
      carData = car;

      loadingEl.style.display = 'none';
      formEl.style.display = 'block';
      
      // Update form with car data
      document.getElementById('car-name').value = `${car.CarName || 'Unknown'} (${car.Brand || 'Unknown'})`;

      const rentalAmountCPT = parseFloat(car.PriceRent || 50);
      const purchasePriceCPT = parseFloat(car.PriceBuy || car.PriceRent * 20 || 1000);

      document.getElementById('rental-amount').value = rentalAmountCPT.toFixed(2);
      
      // Store prices for later use
      window.carPrices = {
        rental: rentalAmountCPT,
        purchase: purchasePriceCPT
      };
      
      // Add date change listeners to calculate total price for rental
      document.getElementById('start-date').addEventListener('change', calculateRentalTotal);
      document.getElementById('end-date').addEventListener('change', calculateRentalTotal);
      
      updateCPTCalculations();

      // Set default dates
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('start-date').value = today;
      document.getElementById('start-date').min = today;

      // Set default time
      const now = new Date();
      document.getElementById('start-time').value =
        `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

      const contractType = document.getElementById('contract-type');
      const endDate = document.getElementById('end-date');
      const endTime = document.getElementById('end-time');
      const paymentOptionsRow = document.getElementById('payment-options-row');
      const paymentType = document.getElementById('payment-type');
      const quarters = document.getElementById('quarters');
      const amountLabel = document.getElementById('amount-label');
      const paymentAmountContainer = document.getElementById('payment-amount-container');
      const rentalAmount = document.getElementById('rental-amount');
      const paymentAmount = document.getElementById('payment-amount');

        const toggleEndFields = () => {
          console.log('toggleEndFields called, contract type:', contractType.value);
          
          if(contractType.value === 'purchase'){
            console.log('Setting up purchase mode');
            
            // Disable date/time fields for purchase
            endDate.disabled = true;
            endTime.disabled = true;
            endDate.classList.add('disabled-input');
            endTime.classList.add('disabled-input');
            endDate.removeAttribute('required');
            endTime.removeAttribute('required');
            
            // Show payment options for purchase
            paymentOptionsRow.style.display = 'flex';
            paymentType.setAttribute('required', '');
            // Set default payment type to avoid form validation error
            if (!paymentType.value) {
              paymentType.value = 'full';
            }
            amountLabel.textContent = 'Purchase Price (CPT)';
            
            // Update amount to purchase price
            if (window.carPrices) {
              rentalAmount.value = window.carPrices.purchase.toFixed(2);
              console.log('Updated purchase price to:', window.carPrices.purchase);
            }
          } else if (contractType.value === 'rental') {
            console.log('Setting up rental mode');
            
            // Enable date/time fields for rental
            endDate.disabled = false;
            endTime.disabled = false;
            endDate.classList.remove('disabled-input');
            endTime.classList.remove('disabled-input');
            endDate.setAttribute('required','');
            endTime.setAttribute('required','');
            
            // Hide payment options for rental
            paymentOptionsRow.style.display = 'none';
            paymentType.removeAttribute('required');
            paymentType.value = ''; // Clear payment type
            paymentAmountContainer.style.display = 'none';
            amountLabel.textContent = 'Total Rental Amount (CPT)';
            
            // Calculate rental total based on dates
            calculateRentalTotal();
          } else {
            console.log('Contract type not selected, hiding payment options');
            
            // Default state - hide payment options
            paymentOptionsRow.style.display = 'none';
            paymentType.removeAttribute('required');
            paymentType.value = ''; // Clear payment type
            paymentAmountContainer.style.display = 'none';
            
            // Enable end date/time fields for rental
            endDate.disabled = false;
            endTime.disabled = false;
            endDate.classList.remove('disabled-input');
            endTime.classList.remove('disabled-input');
            endDate.setAttribute('required','');
            endTime.setAttribute('required','');
            amountLabel.textContent = 'Rental Amount (CPT)';
          }
          
          updateCPTCalculations();
        };
        
        // Payment type change handler
        paymentType.addEventListener('change', function() {
          if (contractType.value === 'purchase') {
            if (this.value === 'quarterly') {
              quarters.disabled = false;
              paymentAmountContainer.style.display = 'block';
              updateQuarterlyPayment();
            } else if (this.value === 'full') {
              quarters.disabled = true;
              paymentAmountContainer.style.display = 'none';
              if (window.carPrices) {
                rentalAmount.value = window.carPrices.purchase.toFixed(2);
              }
            } else {
              quarters.disabled = true;
              paymentAmountContainer.style.display = 'none';
            }
            updateCPTCalculations();
          }
        });
        
        // Quarters change handler
        quarters.addEventListener('change', function() {
          if (contractType.value === 'purchase' && paymentType.value === 'quarterly') {
            updateQuarterlyPayment();
            updateCPTCalculations();
          }
        });
        
        function updateQuarterlyPayment() {
          if (window.carPrices && quarters.value) {
            const quarterlyAmount = window.carPrices.purchase / parseInt(quarters.value);
            paymentAmount.value = quarterlyAmount.toFixed(2);
            rentalAmount.value = quarterlyAmount.toFixed(2); // First payment
          }
        }

        // Ensure event listeners are properly attached
        contractType.addEventListener('change', function() {
          console.log('Contract type changed to:', this.value);
          toggleEndFields();
        });
        
        // Initial call to set up form properly
        toggleEndFields();

        formEl.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          // Collect form data
          const formData = {
            carId: carId,
            contractType: document.getElementById('contract-type').value,
            startDate: document.getElementById('start-date').value,
            endDate: document.getElementById('end-date').value,
            startTime: document.getElementById('start-time').value,
            endTime: document.getElementById('end-time').value,
            rentalAmount: document.getElementById('rental-amount').value,
            walletAddress: currentAccount || 'pending', // Allow creation without wallet initially
            note: document.getElementById('note').value
          };
          
          // Add purchase-specific fields
          if (formData.contractType === 'purchase') {
            formData.paymentType = document.getElementById('payment-type').value;
            if (formData.paymentType === 'quarterly') {
              formData.quarters = document.getElementById('quarters').value;
              formData.quarterlyAmount = document.getElementById('payment-amount').value;
            }
            formData.totalPurchasePrice = window.carPrices?.purchase || 0;
          }

          if(formData.contractType === 'purchase'){
            formData.endDate = null;
            formData.endTime = null;
          }

          // ‚úÖ Create Contract Request (No payment required at this stage)
          try {
            await createContractRequest(formData);
          } catch(error){
            console.error(error);
            alert('Contract request creation failed: '+error.message);
          }
        });
      })
      .catch(err=>{
        console.error('Error loading car data:', err);
        loadingEl.textContent = `Error loading car data: ${err.message}`;
        loadingEl.style.color = 'red';
        
        // Fallback to show form with basic data after 3 seconds
        setTimeout(() => {
          loadingEl.style.display = 'none';
          formEl.style.display = 'block';
          
          // Set basic car data
          document.getElementById('car-name').value = `Car #${carId}`;
          document.getElementById('rental-amount').value = '30.00';
          window.carPrices = { rental: 30, purchase: 600 };
          updateCPTCalculations();

          // Set default dates
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('start-date').value = today;
          document.getElementById('start-date').min = today;

          const now = new Date();
          document.getElementById('start-time').value =
            `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

          // Enable basic form functionality
          const contractType = document.getElementById('contract-type');
          const endDate = document.getElementById('end-date');
          const endTime = document.getElementById('end-time');

          const toggleEndFields = () => {
            if(contractType.value === 'purchase'){
              endDate.disabled = true;
              endTime.disabled = true;
              endDate.classList.add('disabled-input');
              endTime.classList.add('disabled-input');
              endDate.removeAttribute('required');
              endTime.removeAttribute('required');
            } else {
              endDate.disabled = false;
              endTime.disabled = false;
              endDate.classList.remove('disabled-input');
              endTime.classList.remove('disabled-input');
              endDate.setAttribute('required','');
              endTime.setAttribute('required','');
            }
          };

          contractType.addEventListener('change', toggleEndFields);
          toggleEndFields();

          // Add form submit handler for fallback mode
          formEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            alert('Car data could not be loaded. Please try again later.');
          });
        }, 3000);
      });
  })();

  // ‚úÖ Simple contract creation without wallet connection
  async function createContractRequest(formData) {
    try {
      console.log('Creating contract request:', formData);
      
      // Show loading state
      const submitBtn = document.querySelector('.btn-submit');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating Contract Request...';
      
          // Calculate total price based on contract type
          let totalPrice = parseFloat(formData.rentalAmount);
          if (formData.contractType === 'purchase') {
            if (formData.paymentType === 'quarterly') {
              totalPrice = parseFloat(formData.quarterlyAmount || formData.rentalAmount);
            } else {
              totalPrice = parseFloat(formData.totalPurchasePrice || formData.rentalAmount);
            }
          } else if (formData.contractType === 'rental') {
            // For rental, use the calculated total from date range
            totalPrice = parseFloat(formData.rentalAmount);
          }
          
          // Prepare contract data
          const contractData = {
            carId: formData.carId,
            userId: getCurrentUserId(), // Get from auth
            contractType: formData.contractType,
            startDate: formData.startDate,
            endDate: formData.contractType === 'purchase' ? null : formData.endDate,
            startTime: formData.startTime,
            endTime: formData.contractType === 'purchase' ? null : formData.endTime,
            totalPrice: totalPrice,
            paymentType: formData.paymentType || null,
            quarters: formData.quarters || null,
            quarterlyAmount: formData.quarterlyAmount || null,
            totalPurchasePrice: formData.totalPurchasePrice || null,
            note: formData.note || '',
            status: 'Pending' // Initial status
          };      console.log('Contract data to send:', contractData);
      
      // Send to backend
      const response = await fetch('http://localhost:3000/api/contracts/create-request', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(contractData)
      });
      
      const result = await response.json();
      console.log('Contract creation response:', result);
      
      if (result.success) {
        // Show success message with contract ID
        alert(`‚úÖ Contract request created successfully!
        
Contract ID: ${result.contractId}
Status: Pending (waiting for owner confirmation)

You will be notified when the owner confirms your request.
Once confirmed, you can make payment in the "My Contracts" section.`);
        
        // Redirect to my contracts page
        setTimeout(() => {
          window.location.href = 'my_contracts.html';
        }, 2000);
        
      } else {
        throw new Error(result.error || 'Failed to create contract request');
      }
      
    } catch (error) {
      console.error('Error creating contract request:', error);
      alert('Failed to create contract request: ' + error.message);
    } finally {
      // Restore button state
      const submitBtn = document.querySelector('.btn-submit');
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Contract Request';
      }
    }
  }
  
  // Helper function to get current user ID
  function getCurrentUserId() {
    const userStr = localStorage.getItem('user');
    if (userStr) {
      const user = JSON.parse(userStr);
      return user.UserId;
    }
    return null;
  }
  
  // Function to calculate total rental price based on date range
  function calculateRentalTotal() {
    const contractType = document.getElementById('contract-type').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    const rentalAmountInput = document.getElementById('rental-amount');
    
    if (contractType === 'rental' && startDate && endDate && window.carPrices) {
      try {
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        // Validate dates
        if (end <= start) {
          console.warn('End date must be after start date');
          return;
        }
        
        // Calculate number of days
        const timeDifference = end.getTime() - start.getTime();
        const daysDifference = Math.ceil(timeDifference / (1000 * 3600 * 24));
        
        // Calculate total price: (end date - start date) * price_rent
        const dailyRate = window.carPrices.rental;
        const totalPrice = daysDifference * dailyRate;
        
        console.log('Rental calculation:', {
          startDate,
          endDate,
          days: daysDifference,
          dailyRate,
          totalPrice
        });
        
        // Update the rental amount field
        rentalAmountInput.value = totalPrice.toFixed(2);
        
        // Update CPT calculations
        updateCPTCalculations();
        
        // Show calculation info to user
        const amountLabel = document.getElementById('amount-label');
        amountLabel.textContent = `Total Rental Amount (${daysDifference} days √ó ${dailyRate} CPT)`;
        
      } catch (error) {
        console.error('Error calculating rental total:', error);
      }
    }
  }
  // Function to calculate ETH required for CPT amount
  function calculateETHAmount(cptAmount) {
    return cptAmount * CPT_TOKEN_PRICE;
  }

  // Function to buy CPT tokens with ETH automatically during payment
  async function buyTokensWithETH(cptAmount) {
    try {
      if (!provider || !currentAccount) {
        throw new Error('Please connect your wallet first');
      }

      const signer = await provider.getSigner();
      const ethRequired = calculateETHAmount(cptAmount);
      
      console.log(`Buying ${cptAmount} CPT tokens for ${ethRequired} ETH`);

      // CPT Token contract ABI
      const cptTokenAbi = [
        "function buyTokens() public payable",
        "function balanceOf(address owner) view returns (uint256)",
        "function tokenPrice() view returns (uint256)"
      ];

      const cptTokenContract = new ethers.Contract(
        CONTRACT_ADDRESSES.CPT_TOKEN,
        cptTokenAbi,
        signer
      );

      // Convert ETH to Wei
      const ethInWei = ethers.parseEther(ethRequired.toString());

      console.log('Calling buyTokens with ETH amount:', ethInWei.toString());

      // Call buyTokens function with ETH payment
      const tx = await cptTokenContract.buyTokens({
        value: ethInWei
      });

      console.log('Buy tokens transaction submitted:', tx.hash);
      
      return {
        tx: tx,
        ethSpent: ethRequired,
        cptReceived: cptAmount
      };

    } catch (error) {
      console.error('Error buying tokens:', error);
      throw new Error(`Failed to buy CPT tokens: ${error.message}`);
    }
  }



  async function createRentalAgreement(formData){
    try {
      const submitBtn = document.querySelector('.btn-submit');
      const originalText = submitBtn.textContent;
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing Payment...';
      
      console.log('Creating rental agreement with data:', formData);

      // ‚úÖ STEP 1: Calculate ETH required for CPT amount
      const cptAmount = parseFloat(formData.rentalAmount);
      const ethRequired = calculateETHAmount(cptAmount);
      
      console.log(`Payment: ${cptAmount} CPT = ${ethRequired} ETH`);
      
      // ‚úÖ STEP 2: Buy CPT tokens with ETH first
      submitBtn.textContent = 'Buying CPT Tokens...';
      
      const tokenPurchase = await buyTokensWithETH(cptAmount);
      
      // Wait for token purchase confirmation
      const tokenReceipt = await tokenPurchase.tx.wait();
      
      console.log('Token purchase confirmed:', tokenReceipt);
      
      alert(`‚úÖ CPT Tokens purchased successfully!
      
üîó Transaction Hash: ${tokenReceipt.hash}
üí∞ ETH Spent: ${tokenPurchase.ethSpent.toFixed(6)} ETH
ü™ô CPT Received: ${tokenPurchase.cptReceived} CPT
‚õΩ Gas Used: ${tokenReceipt.gasUsed.toString()}

Now creating rental agreement...`);
      
      // ‚úÖ STEP 3: Create rental agreement using backend API
      submitBtn.textContent = 'Creating Contract...';
      
      // Add token purchase info to form data
      formData.tokenPurchaseTx = tokenReceipt.hash;
      formData.ethSpent = tokenPurchase.ethSpent;
      
      const response = await fetch(`${API_BASE_URL}/rental/create`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error || 'Failed to create rental agreement');
      }
      
      // Success notification
      alert(`üéâ Rental agreement created successfully!
      
üí∞ PAYMENT COMPLETED:
üí≥ ETH Paid: ${tokenPurchase.ethSpent.toFixed(6)} ETH
ü™ô CPT Tokens: ${tokenPurchase.cptReceived} CPT
üîó Payment Tx: ${tokenReceipt.hash}

üìã CONTRACT CREATED:
Contract ID: ${result.data.contractId}
Transaction Hash: ${result.data.txHash}
Agreement Address: ${result.data.agreementAddress}
Gas Used: ${result.data.gasUsed}

${result.data.pdf ? `üìÑ CONTRACT PDF:
IPFS Hash: ${result.data.pdf.ipfsHash}
PDF URL: ${result.data.pdf.pinataUrl}
File Size: ${Math.round(result.data.pdf.size / 1024)} KB` : ''}

Payment completed and contract deployed to blockchain!`);

      console.log('Rental agreement created:', result.data);
      
      // Optionally redirect to contracts page
      const redirect = confirm('Would you like to view your contracts now?');
      if (redirect) {
        window.location.href = 'my_contracts.html';
      }
      
    } catch (error) {
      console.error('Error creating rental agreement:', error);
      
      alert(`‚ùå Payment/Contract creation failed!
      
Error: ${error.message}

Please try again or contact support if the issue persists.`);
      
      throw error;
    } finally {
      const submitBtn = document.querySelector('.btn-submit');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Create Contract Request';
    }
  }

  // Direct smart contract interaction with ETH payment
  async function createRentalContractDirect(formData) {
    try {
      if (!provider || !currentAccount) {
        throw new Error('Please connect your wallet first');
      }

      // ‚úÖ STEP 1: Buy CPT tokens with ETH first
      const cptAmount = parseFloat(formData.rentalAmount);
      const tokenPurchase = await buyTokensWithETH(cptAmount);
      const tokenReceipt = await tokenPurchase.tx.wait();
      
      console.log('‚úÖ CPT tokens purchased:', tokenReceipt.hash);

      // ‚úÖ STEP 2: Get signer for contract creation
      const signer = await provider.getSigner();
      
      // Factory contract instance
      const factoryAbi = [
        "function createAgreement(address _user, address _token, uint256 _vehicleId, uint256 _rentAmount, uint256 _depositAmount) returns (address)",
        "event AgreementCreated(address indexed agreement, address indexed owner, address indexed user)"
      ];
      
      const factoryContract = new ethers.Contract(
        CONTRACT_ADDRESSES.FACTORY, 
        factoryAbi, 
        signer
      );

      // Convert amounts to proper units (assuming 18 decimals)
      const rentalAmount = ethers.parseUnits(formData.rentalAmount.toString(), 18);
      const vehicleId = ethers.hashMessage(formData.carId); // Convert carId to bytes32

      console.log('Calling createAgreement with:', {
        user: currentAccount,
        token: CONTRACT_ADDRESSES.CPT_TOKEN,
        vehicleId: vehicleId,
        rentAmount: rentalAmount.toString(),
        depositAmount: '0'
      });

      // ‚úÖ STEP 3: Call the createAgreement function
      const tx = await factoryContract.createAgreement(
        currentAccount,                    // _user (current user)
        CONTRACT_ADDRESSES.CPT_TOKEN,     // _token (CPT token address)
        vehicleId,                        // _vehicleId (car ID as bytes32)
        rentalAmount,                     // _rentAmount
        ethers.parseUnits('0', 18)        // _depositAmount (no deposit)
      );

      console.log('Contract creation transaction submitted:', tx.hash);

      // ‚úÖ STEP 4: Wait for transaction confirmation
      const receipt = await tx.wait();
      
      console.log('Contract creation confirmed:', receipt);
      
      // ‚úÖ STEP 5: Extract agreement address from events
      let agreementAddress = 'Unknown';
      
      for (const log of receipt.logs) {
        try {
          const decoded = factoryContract.interface.parseLog({
            topics: log.topics,
            data: log.data
          });
          
          if (decoded.name === 'AgreementCreated') {
            agreementAddress = decoded.args.agreement;
            console.log('New agreement created at:', agreementAddress);
            break;
          }
        } catch (error) {
          continue;
        }
      }

      let alertMessage = `üéâ ${formData.contractType === 'purchase' ? 'Purchase' : 'Rental'} agreement created successfully!

üí∞ PAYMENT COMPLETED:
üí≥ ETH Paid: ${tokenPurchase.ethSpent.toFixed(6)} ETH
ü™ô CPT Tokens: ${tokenPurchase.cptReceived} CPT
üîó Payment Tx: ${tokenReceipt.hash}

‚úÖ CONTRACT DEPLOYED:
üìç Agreement Address: ${agreementAddress}
üîó Contract Tx: ${receipt.hash}
‚õΩ Gas Used: ${receipt.gasUsed.toString()}
üì¶ Block Number: ${receipt.blockNumber}`;
      
      if (formData.contractType === 'purchase') {
        if (formData.paymentType === 'quarterly') {
          alertMessage += `

üìã PAYMENT PLAN:
üî¢ Total Price: ${formData.totalPurchasePrice} CPT
üìÖ Payment Terms: ${formData.quarters} quarters
üí∞ Amount per Quarter: ${formData.quarterlyAmount} CPT
‚úÖ First Payment: Completed
‚è≥ Next Payments: ${formData.quarters - 1} remaining`;
        } else {
          alertMessage += `
üí∞ Full Purchase: ${formData.totalPurchasePrice} CPT (Paid)`;
        }
      }
      
      alertMessage += `

Payment completed and contract deployed!`;
      
      alert(alertMessage);

      // ‚úÖ STEP 6: Store contract info in database
      try {
        await fetch(`${API_BASE_URL}/rental/store-contract`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contractAddress: agreementAddress,
            txHash: receipt.hash,
            carId: formData.carId,
            userId: localStorage.getItem('userId'),
            walletAddress: currentAccount,
            rentalAmount: formData.rentalAmount,
            contractType: formData.contractType,
            startDate: formData.startDate,
            endDate: formData.endDate,
            blockNumber: receipt.blockNumber,
            gasUsed: receipt.gasUsed.toString(),
            // Store payment info
            paymentTxHash: tokenReceipt.hash,
            ethSpent: tokenPurchase.ethSpent,
            note: formData.note || ''
          })
        });
      } catch (dbError) {
        console.warn('Failed to store contract info in database:', dbError);
      }

      return {
        txHash: receipt.hash,
        agreementAddress: agreementAddress,
        gasUsed: receipt.gasUsed.toString(),
        blockNumber: receipt.blockNumber,
        paymentTxHash: tokenReceipt.hash,
        ethSpent: tokenPurchase.ethSpent
      };

    } catch (error) {
      console.error('Contract creation with ETH payment failed:', error);
      throw new Error(`Contract creation failed: ${error.message}`);
    }
  }

  function updateCPTCalculations(){
    const rentalCPT = parseFloat(document.getElementById('rental-amount').value || 0);
    const totalETH = calculateETHAmount(rentalCPT);

    // Update amount label to show ETH equivalent
    const amountLabel = document.getElementById('amount-label');
    if (amountLabel && rentalCPT > 0) {
      const baseText = amountLabel.textContent.split(' (')[0]; // Keep base text, remove old calculation
      amountLabel.textContent = `${baseText} (‚âà ${totalETH.toFixed(6)} ETH)`;
    }

    console.log(`Payment calculation: ${rentalCPT} CPT = ${totalETH} ETH`);
  }

  // ===== SIGNATURE MANAGEMENT FUNCTIONS =====
  
  let currentContractAddress = null;
  
  function showSignatureSection(contractAddress) {
    currentContractAddress = contractAddress;
    
    const signatureSection = document.getElementById('signature-section');
    const contractAddressDisplay = document.getElementById('contract-address-display');
    
    contractAddressDisplay.textContent = contractAddress;
    signatureSection.style.display = 'block';
    
    // Setup event listeners
    document.getElementById('sign-as-user-btn').addEventListener('click', signAsUser);
    document.getElementById('check-signatures-btn').addEventListener('click', checkSignatureStatus);
    document.getElementById('simulate-owner-sign-btn').addEventListener('click', simulateOwnerSign);
    
    // Initial status check
    checkSignatureStatus();
    
    // Hide form submit button
    document.querySelector('.btn-submit').style.display = 'none';
  }
  
  async function checkSignatureStatus() {
    try {
      if (!currentContractAddress || !provider) return;
      
      const signer = await provider.getSigner();
      const agreementAbi = [
        "function ownerSigned() view returns (bool)",
        "function userSigned() view returns (bool)",
        "function status() view returns (uint8)",
        "function owner() view returns (address)",
        "function user() view returns (address)"
      ];
      
      const agreementContract = new ethers.Contract(
        currentContractAddress,
        agreementAbi,
        signer
      );
      
      const [ownerSigned, userSigned, status, owner, user] = await Promise.all([
        agreementContract.ownerSigned(),
        agreementContract.userSigned(),
        agreementContract.status(),
        agreementContract.owner(),
        agreementContract.user()
      ]);
      
      console.log('Signature status:', { ownerSigned, userSigned, status, owner, user });
      
      // Update UI
      updateSignatureUI(ownerSigned, userSigned, status);
      
      // Enable user sign button if owner signed and user hasn't
      const signUserBtn = document.getElementById('sign-as-user-btn');
      signUserBtn.disabled = !ownerSigned || userSigned;
      
      if (ownerSigned && userSigned) {
        document.getElementById('contract-status').textContent = 'Active ‚úÖ';
        alert('üéâ Contract is now ACTIVE! Both parties have signed.');
      }
      
    } catch (error) {
      console.error('Error checking signature status:', error);
    }
  }
  
  function updateSignatureUI(ownerSigned, userSigned, status) {
    // Update owner signature status
    const ownerIcon = document.getElementById('owner-sign-icon');
    const ownerStatus = document.getElementById('owner-sign-status');
    
    if (ownerSigned) {
      ownerIcon.textContent = '‚úÖ';
      ownerStatus.textContent = 'Signed';
      ownerStatus.className = 'step-status signed';
    } else {
      ownerIcon.textContent = '‚è≥';
      ownerStatus.textContent = 'Waiting...';
      ownerStatus.className = 'step-status pending';
    }
    
    // Update user signature status
    const userIcon = document.getElementById('user-sign-icon');
    const userStatus = document.getElementById('user-sign-status');
    
    if (userSigned) {
      userIcon.textContent = '‚úÖ';
      userStatus.textContent = 'Signed';
      userStatus.className = 'step-status signed';
    } else {
      userIcon.textContent = '‚è≥';
      userStatus.textContent = 'Waiting...';
      userStatus.className = 'step-status pending';
    }
  }
  
  async function signAsUser() {
    try {
      if (!currentContractAddress || !provider) {
        throw new Error('Contract not initialized');
      }
      
      const submitBtn = document.getElementById('sign-as-user-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Signing...';
      
      const signer = await provider.getSigner();
      const agreementAbi = [
        "function signAgreementAsUser(uint256 _durationDays, uint256 _intervalDays)"
      ];
      
      const agreementContract = new ethers.Contract(
        currentContractAddress,
        agreementAbi,
        signer
      );
      
      // Calculate rental duration (example: 30 days with 30-day intervals)
      const durationDays = 30;
      const intervalDays = 30;
      
      console.log('Signing as user with duration:', durationDays, 'interval:', intervalDays);
      
      const tx = await agreementContract.signAgreementAsUser(durationDays, intervalDays);
      
      alert(`üîÑ Signing transaction submitted!
      
Hash: ${tx.hash}
Please wait for confirmation...`);
      
      const receipt = await tx.wait();
      
      alert(`‚úÖ Successfully signed as User!
      
Transaction Hash: ${receipt.hash}
Gas Used: ${receipt.gasUsed.toString()}

Waiting for Car Owner signature...`);
      
      // Refresh status
      setTimeout(() => checkSignatureStatus(), 2000);
      
    } catch (error) {
      console.error('User signature failed:', error);
      alert('Signature failed: ' + error.message);
    } finally {
      const submitBtn = document.getElementById('sign-as-user-btn');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Sign as User';
    }
  }
  
  async function simulateOwnerSign() {
    try {
      alert('üß™ Test Mode: Simulating Owner signature...');
      
      // This would normally be done by the car owner
      // For testing purposes, we'll call the backend API
      const response = await fetch(`${API_BASE_URL}/rental/sign-as-owner`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contractAddress: currentContractAddress
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert(`‚úÖ Owner signature simulated!
        
Transaction Hash: ${result.txHash}
        
Now you can sign as User.`);
        
        // Refresh status
        setTimeout(() => checkSignatureStatus(), 2000);
      } else {
        throw new Error(result.error || 'Failed to simulate owner signature');
      }
      
    } catch (error) {
      console.error('Owner signature simulation failed:', error);
      alert('Owner signature simulation failed: ' + error.message);
    }
  }
</script>
</body>
</html>