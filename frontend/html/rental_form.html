<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rental / Purchase Form | Morent</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../css/rental_form.css" />
  <style>
    .disabled-input {
      background-color: #f3f4f6 !important;
      color: #9ca3af !important;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }
    .wallet-section {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .wallet-status {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #dc3545;
    }
    .status-dot.connected {
      background: #28a745;
    }
    .btn-wallet {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-wallet:hover {
      background: #0056b3;
    }
    .btn-wallet:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .token-info {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin-top: 15px;
    }
    .price-conversion {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
      padding: 10px;
      background: #e7f3ff;
      border-radius: 5px;
    }
    .error-message {
      color: #dc3545;
      font-size: 14px;
      margin-top: 5px;
    }
    .success-message {
      color: #28a745;
      font-size: 14px;
      margin-top: 5px;
    }
  </style>
</head>

<body>
  <header>
    <div class="logo">MORENT</div>
    <div class="search-bar">
      <input type="text" placeholder="Search something here..." />
      <img src="../image/search.svg" alt="search" />
    </div>
    <div class="user-icons">
      <img src="../image/heart.svg" alt="heart">
      <img src="../image/notification.svg" alt="bell">
      <img src="../image/setting.svg" alt="setting">
      <img src="https://i.pravatar.cc/40" alt="avatar" class="avatar">
    </div>
  </header>

  <main>
    <h1>Rental / Purchase Form</h1>

    <!-- Loading -->
    <div id="loading" class="loading">Loading car information...</div>

    <!-- Form -->
    <form id="rentalForm" style="display: none;">
      <div class="form-row">
        <div>
          <label for="car-name">Car Name</label>
          <input type="text" id="car-name" readonly>
        </div>
        <div>
          <label for="contract-type">Contract Type</label>
          <select id="contract-type" required>
            <option value="">-- Select --</option>
            <option value="rental">Rental</option>
            <option value="purchase">Purchase</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="start-date">Start Date</label>
          <input type="date" id="start-date" required>
        </div>
        <div>
          <label for="end-date">End Date</label>
          <input type="date" id="end-date" required>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="start-time">Start Time</label>
          <input type="time" id="start-time" required>
        </div>
        <div>
          <label for="end-time">End Time</label>
          <input type="time" id="end-time" required>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="deposit">Deposit (CPT)</label>
          <input type="number" id="deposit" readonly>
        </div>
        <div>
          <label for="rental-amount">Rental Amount (CPT)</label>
          <input type="number" id="rental-amount" readonly>
        </div>
      </div>

      <!-- Wallet Section -->
      <div class="wallet-section">
        <h3>Wallet & Payment</h3>
        
        <div class="wallet-status">
          <div class="status-dot" id="wallet-status-dot"></div>
          <span id="wallet-status-text">Wallet not connected</span>
        </div>
        
        <button type="button" class="btn-wallet" id="connect-wallet-btn">
          Connect MetaMask Wallet
        </button>
        
        <div id="wallet-info" style="display: none;">
          <div class="token-info">
            <h4>Account Information</h4>
            <p><strong>Address:</strong> <span id="wallet-address"></span></p>
            <p><strong>ETH Balance:</strong> <span id="eth-balance">0</span> ETH</p>
            <p><strong>CPT Balance:</strong> <span id="cpt-balance">0</span> CPT</p>
            
            <div class="price-conversion">
              <div>
                <strong>Required CPT:</strong> <span id="total-cpt-needed">0</span> CPT
              </div>
              <div>
                <strong>≈ ETH Cost:</strong> <span id="total-eth-cost">0</span> ETH
              </div>
            </div>
            
            <div id="insufficient-balance" style="display: none;">
              <p class="error-message">⚠️ Insufficient CPT balance. You need to buy more tokens.</p>
              <button type="button" class="btn-wallet" id="buy-tokens-btn">
                Buy CPT Tokens
              </button>
            </div>
            
            <div id="sufficient-balance" style="display: none;">
              <p class="success-message">✅ Sufficient CPT balance for this rental.</p>
            </div>
          </div>
        </div>
      </div>

      <div>
        <label for="note">Additional Note</label>
        <textarea id="note" rows="4" placeholder="Enter special requests or remarks..."></textarea>
      </div>

      <button type="submit" class="btn-submit">Tạo hợp đồng</button>
    </form>
  </main>

  <footer>
    <div class="top">
      <div>
        <div class="logo">MORENT</div>
        <p class="desc">Our vision is to provide convenience and help increase your sales business.</p>
      </div>
      <div class="links">
        <div><h4>About</h4><a href="#">How it works</a><a href="#">Featured</a><a href="#">Partnership</a><a href="#">Business Relation</a></div>
        <div><h4>Community</h4><a href="#">Events</a><a href="#">Blog</a><a href="#">Podcast</a><a href="#">Invite a friend</a></div>
        <div><h4>Socials</h4><a href="#">Discord</a><a href="#">Instagram</a><a href="#">Twitter</a><a href="#">Facebook</a></div>
      </div>
    </div>
    <div class="bottom">
      <span>©2022 MORENT. All rights reserved</span>
      <div><a href="#">Privacy & Policy</a> | <a href="#">Terms & Condition</a></div>
    </div>
  </footer>

  <!-- ============= SCRIPT – WALLET & CPT INTEGRATION ============= -->
  <script>
    // Constants for smart contracts
    const CPT_TOKEN_PRICE = 0.000287; // ETH per CPT token
    const CONTRACT_ADDRESSES = {
      CPT_TOKEN: '0x...', // Địa chỉ contract CPT token sau khi deploy
      FACTORY: '0x...'    // Địa chỉ contract Factory sau khi deploy
    };

    // Global variables
    let web3 = null;
    let currentAccount = null;
    let cptContract = null;
    let ethBalance = 0;
    let cptBalance = 0;
    let carData = null;

    // BỌC TOÀN BỘ TRONG IIFE → return HỢP LỆ
    (function () {
      const urlParams = new URLSearchParams(window.location.search);
      const carId = urlParams.get('carId');

      const loadingEl = document.getElementById('loading');
      const formEl = document.getElementById('rentalForm');

      if (!carId) {
        loadingEl.textContent = 'Error: No car selected!';
        loadingEl.style.color = 'red';
        console.error('No carId in URL');
        return; // OK: return trong hàm
      }

      console.log('Fetching car:', carId);
      
      // Initialize wallet functionality
      initializeWallet();

      fetch(`http://localhost:3000/api/admin/cars/${carId}`)
        .then(res => {
          if (!res.ok) throw new Error('Car not found');
          return res.json();
        })
        .then(data => {
          if (!data.success || !data.car) {
            throw new Error(data.error || 'Invalid response');
          }

          const car = data.car;
          carData = car; // Store globally
          console.log('Car loaded:', car);

          // Ẩn loading
          loadingEl.style.display = 'none';
          formEl.style.display = 'block';

          // Điền dữ liệu
          document.getElementById('car-name').value = `${car.CarName} (${car.Brand})`;

          // Convert prices to CPT (assuming 1 USD = 1 CPT for simplicity)
          const depositUSD = car.PriceBuy 
            ? parseFloat(car.PriceBuy) 
            : parseFloat(car.PriceRent || 0) * 0.1;
          const rentalAmountUSD = parseFloat(car.PriceRent || 0);
          
          // Convert to CPT (1 USD ≈ 1 CPT)
          const depositCPT = depositUSD;
          const rentalAmountCPT = rentalAmountUSD;
          
          document.getElementById('deposit').value = depositCPT.toFixed(2);
          document.getElementById('rental-amount').value = rentalAmountCPT.toFixed(2);
          
          // Update CPT calculations
          updateCPTCalculations();

          // Start Date = hôm nay
          const today = new Date().toISOString().split('T')[0];
          const startDateEl = document.getElementById('start-date');
          startDateEl.value = today;
          startDateEl.min = today;

          // Start Time = hiện tại
          const now = new Date();
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          document.getElementById('start-time').value = `${hours}:${minutes}`;

          // Xử lý Contract Type
          const contractType = document.getElementById('contract-type');
          const endDate = document.getElementById('end-date');
          const endTime = document.getElementById('end-time');

          const toggleEndFields = () => {
            if (contractType.value === 'purchase') {
              endDate.disabled = true;
              endTime.disabled = true;
              endDate.classList.add('disabled-input');
              endTime.classList.add('disabled-input');
              endDate.removeAttribute('required');
              endTime.removeAttribute('required');
            } else {
              endDate.disabled = false;
              endTime.disabled = false;
              endDate.classList.remove('disabled-input');
              endTime.classList.remove('disabled-input');
              endDate.setAttribute('required', '');
              endTime.setAttribute('required', '');
            }
          };

          contractType.addEventListener('change', toggleEndFields);
          toggleEndFields(); // Gọi lần đầu

          // Submit
          formEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentAccount) {
              alert('Please connect your wallet first!');
              return;
            }
            
            const formData = new FormData(formEl);
            const data = Object.fromEntries(formData);
            data.carId = carId;
            data.walletAddress = currentAccount;

            if (data.contractType === 'purchase') {
              data.endDate = null;
              data.endTime = null;
            }

            // Check CPT balance
            const totalCPTNeeded = parseFloat(document.getElementById('deposit').value) + 
                                  parseFloat(document.getElementById('rental-amount').value);
            
            if (cptBalance < totalCPTNeeded) {
              alert('Insufficient CPT balance. Please buy more tokens first.');
              return;
            }

            try {
              // Create rental agreement through smart contract
              await createRentalAgreement(data);
            } catch (error) {
              console.error('Contract creation failed:', error);
              alert('Failed to create rental agreement: ' + error.message);
            }
          });
        })
        .catch(err => {
          loadingEl.textContent = `Error: ${err.message}`;
          loadingEl.style.color = 'red';
          console.error('Fetch error:', err);
        });
    })();

    // ===== WALLET FUNCTIONS =====
    function initializeWallet() {
      const connectBtn = document.getElementById('connect-wallet-btn');
      const buyTokensBtn = document.getElementById('buy-tokens-btn');
      
      connectBtn.addEventListener('click', connectWallet);
      buyTokensBtn.addEventListener('click', buyTokens);
      
      // Check if MetaMask is installed
      if (typeof window.ethereum === 'undefined') {
        connectBtn.textContent = 'Install MetaMask';
        connectBtn.onclick = () => window.open('https://metamask.io/', '_blank');
      }
    }

    async function connectWallet() {
      try {
        if (typeof window.ethereum === 'undefined') {
          alert('MetaMask not installed!');
          return;
        }

        // Request account access
        const accounts = await window.ethereum.request({
          method: 'eth_requestAccounts'
        });
        
        currentAccount = accounts[0];
        
        // Initialize Web3
        web3 = new Web3(window.ethereum);
        
        // Update UI
        updateWalletUI();
        
        // Load balances
        await loadBalances();
        
        console.log('Wallet connected:', currentAccount);
      } catch (error) {
        console.error('Wallet connection failed:', error);
        alert('Failed to connect wallet: ' + error.message);
      }
    }

    function updateWalletUI() {
      const statusDot = document.getElementById('wallet-status-dot');
      const statusText = document.getElementById('wallet-status-text');
      const walletInfo = document.getElementById('wallet-info');
      const connectBtn = document.getElementById('connect-wallet-btn');
      const addressEl = document.getElementById('wallet-address');
      
      if (currentAccount) {
        statusDot.classList.add('connected');
        statusText.textContent = 'Wallet Connected';
        walletInfo.style.display = 'block';
        connectBtn.style.display = 'none';
        addressEl.textContent = currentAccount.substring(0, 6) + '...' + currentAccount.substring(38);
      } else {
        statusDot.classList.remove('connected');
        statusText.textContent = 'Wallet not connected';
        walletInfo.style.display = 'none';
        connectBtn.style.display = 'inline-block';
      }
    }

    async function loadBalances() {
      try {
        // Get ETH balance
        const ethBalanceWei = await web3.eth.getBalance(currentAccount);
        ethBalance = parseFloat(web3.utils.fromWei(ethBalanceWei, 'ether'));
        document.getElementById('eth-balance').textContent = ethBalance.toFixed(4);
        
        // Get CPT balance (mock for now)
        // TODO: Implement actual CPT contract interaction
        cptBalance = 100; // Mock balance
        document.getElementById('cpt-balance').textContent = cptBalance.toFixed(2);
        
        updateCPTCalculations();
        
      } catch (error) {
        console.error('Failed to load balances:', error);
      }
    }

    function updateCPTCalculations() {
      const depositCPT = parseFloat(document.getElementById('deposit').value || 0);
      const rentalCPT = parseFloat(document.getElementById('rental-amount').value || 0);
      const totalCPT = depositCPT + rentalCPT;
      const totalETH = totalCPT * CPT_TOKEN_PRICE;
      
      document.getElementById('total-cpt-needed').textContent = totalCPT.toFixed(2);
      document.getElementById('total-eth-cost').textContent = totalETH.toFixed(6);
      
      // Check if balance is sufficient
      const insufficientEl = document.getElementById('insufficient-balance');
      const sufficientEl = document.getElementById('sufficient-balance');
      
      if (currentAccount) {
        if (cptBalance >= totalCPT) {
          insufficientEl.style.display = 'none';
          sufficientEl.style.display = 'block';
        } else {
          insufficientEl.style.display = 'block';
          sufficientEl.style.display = 'none';
        }
      }
    }

    async function buyTokens() {
      try {
        const depositCPT = parseFloat(document.getElementById('deposit').value || 0);
        const rentalCPT = parseFloat(document.getElementById('rental-amount').value || 0);
        const totalCPTNeeded = depositCPT + rentalCPT;
        const cptToBuy = Math.max(totalCPTNeeded - cptBalance, totalCPTNeeded);
        const ethRequired = cptToBuy * CPT_TOKEN_PRICE;
        
        if (ethBalance < ethRequired) {
          alert(`Insufficient ETH balance. You need ${ethRequired.toFixed(6)} ETH to buy ${cptToBuy.toFixed(2)} CPT tokens.`);
          return;
        }
        
        // TODO: Implement actual token purchase
        alert(`Buying ${cptToBuy.toFixed(2)} CPT tokens for ${ethRequired.toFixed(6)} ETH...`);
        console.log('Token purchase initiated:', { cptToBuy, ethRequired });
        
        // Mock successful purchase
        cptBalance += cptToBuy;
        ethBalance -= ethRequired;
        document.getElementById('cpt-balance').textContent = cptBalance.toFixed(2);
        document.getElementById('eth-balance').textContent = ethBalance.toFixed(4);
        updateCPTCalculations();
        
      } catch (error) {
        console.error('Token purchase failed:', error);
        alert('Failed to buy tokens: ' + error.message);
      }
    }

    async function createRentalAgreement(formData) {
      try {
        alert('Creating rental agreement on blockchain...');
        console.log('Rental Agreement Data:', formData);
        
        // TODO: Implement actual smart contract interaction
        // This would call the RentalAgreementFactory contract
        
        alert('Rental agreement created successfully!');
        
        // Redirect to contracts page or show confirmation
        // window.location.href = '/my_contracts.html';
        
      } catch (error) {
        throw error;
      }
    }

  </script>
  
  <!-- Web3.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
</body>
</html>