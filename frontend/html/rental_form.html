<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rental / Purchase Form | Morent</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../css/rental_form.css" />
  <style>
    .disabled-input {
      background-color: #f3f4f6 !important;
      color: #9ca3af !important;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }
    .wallet-section {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .wallet-status {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #dc3545;
    }
    .status-dot.connected {
      background: #28a745;
    }
    .btn-wallet {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-wallet:hover {
      background: #0056b3;
    }
    .btn-wallet:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .token-info {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin-top: 15px;
    }
    .price-conversion {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
      padding: 10px;
      background: #e7f3ff;
      border-radius: 5px;
    }
    .error-message {
      color: #dc3545;
      font-size: 14px;
      margin-top: 5px;
    }
    .success-message {
      color: #28a745;
      font-size: 14px;
      margin-top: 5px;
    }
    
    /* Signature Section Styles */
    #signature-section {
      border: 2px solid #007bff;
      border-radius: 10px;
      padding: 20px;
      background: #f8f9ff;
    }
    
    .signature-info h3 {
      color: #007bff;
      margin-bottom: 15px;
    }
    
    .signature-progress {
      margin: 20px 0;
    }
    
    .signature-step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid #e9ecef;
    }
    
    .step-icon {
      font-size: 20px;
      width: 30px;
      text-align: center;
    }
    
    .step-status {
      margin-left: auto;
      font-weight: 600;
      color: #666;
    }
    
    .step-status.signed {
      color: #28a745;
    }
    
    .step-status.pending {
      color: #ffc107;
    }
    
    .signature-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    
    .signature-actions .btn-wallet {
      flex: 1;
      min-width: 150px;
    }
  </style>
</head>

<body>
  <header>
    <div class="logo">MORENT</div>
    <div class="search-bar">
      <input type="text" placeholder="Search something here..." />
      <img src="../image/search.svg" alt="search" />
    </div>
    <div class="user-icons">
      <img src="../image/heart.svg" alt="heart">
      <img src="../image/notification.svg" alt="bell">
      <img src="../image/setting.svg" alt="setting">
      <img src="https://i.pravatar.cc/40" alt="avatar" class="avatar">
    </div>
  </header>

  <main>
    <h1>Rental / Purchase Form</h1>

    <!-- Loading -->
    <div id="loading" class="loading">Loading car information...</div>

    <!-- Form -->
    <form id="rentalForm" style="display: none;">
      <div class="form-row">
        <div>
          <label for="car-name">Car Name</label>
          <input type="text" id="car-name" readonly>
        </div>
        <div>
          <label for="contract-type">Contract Type</label>
          <select id="contract-type" required>
            <option value="">-- Select --</option>
            <option value="rental">Rental</option>
            <option value="purchase">Purchase</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="start-date">Start Date</label>
          <input type="date" id="start-date" required>
        </div>
        <div>
          <label for="end-date">End Date</label>
          <input type="date" id="end-date" required>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="start-time">Start Time</label>
          <input type="time" id="start-time" required>
        </div>
        <div>
          <label for="end-time">End Time</label>
          <input type="time" id="end-time" required>
        </div>
      </div>

      <!-- T√πy ch·ªçn thanh to√°n cho mua xe -->
      <div class="form-row" id="payment-options-row" style="display: none;">
        <div>
          <label for="payment-type">Payment Type</label>
          <select id="payment-type" required>
            <option value="">-- Select Payment Type --</option>
            <option value="full">Pay Full Amount</option>
            <option value="quarterly">Pay by Quarter</option>
          </select>
        </div>
        <div>
          <label for="quarters">Number of Quarters</label>
          <select id="quarters" disabled>
            <option value="4">4 Quarters (1 Year)</option>
            <option value="8">8 Quarters (2 Years)</option>
            <option value="12">12 Quarters (3 Years)</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="rental-amount" id="amount-label">Rental Amount (CPT)</label>
          <input type="number" id="rental-amount" readonly>
        </div>
        <div id="payment-amount-container" style="display: none;">
          <label for="payment-amount">Payment Amount (CPT)</label>
          <input type="number" id="payment-amount" readonly>
        </div>
      </div>

      <!-- Wallet Section -->
      <div class="wallet-section">
        <h3>Wallet & Payment</h3>
        
        <div class="wallet-status">
          <div class="status-dot" id="wallet-status-dot"></div>
          <span id="wallet-status-text">Wallet not connected</span>
        </div>
        
        <button type="button" class="btn-wallet" id="connect-wallet-btn">
          Connect MetaMask Wallet
        </button>
        
        <div id="wallet-info" style="display: none;">
          <div class="token-info">
            <h4>Account Information</h4>
            <p><strong>Address:</strong> <span id="wallet-address"></span></p>
            <p><strong>ETH Balance:</strong> <span id="eth-balance">0</span> ETH</p>
            <p><strong>CPT Balance:</strong> <span id="cpt-balance">0</span> CPT</p>
            
            <div class="price-conversion">
              <div>
                <strong>Required CPT:</strong> <span id="total-cpt-needed">0</span> CPT
              </div>
              <div>
                <strong>‚âà ETH Cost:</strong> <span id="total-eth-cost">0</span> ETH
              </div>
            </div>
            
            <div id="insufficient-balance" style="display: none;">
              <p class="error-message">‚ö†Ô∏è Insufficient CPT balance. You need to buy more tokens.</p>
              <button type="button" class="btn-wallet" id="buy-tokens-btn">
                Buy CPT Tokens
              </button>
            </div>
            
            <div id="sufficient-balance" style="display: none;">
              <p class="success-message">‚úÖ Sufficient CPT balance for this rental.</p>
            </div>
          </div>
        </div>
      </div>

      <div>
        <label for="note">Additional Note</label>
        <textarea id="note" rows="4" placeholder="Enter special requests or remarks..."></textarea>
      </div>

      <button type="submit" class="btn-submit">T·∫°o h·ª£p ƒë·ªìng thu√™</button>
      
      <!-- Signature Section (Hidden initially) -->
      <div id="signature-section" style="display: none; margin-top: 20px;">
        <h3>üîê Digital Signature Required</h3>
        <div class="signature-info">
          <p><strong>Contract Address:</strong> <span id="contract-address-display">-</span></p>
          <p><strong>Status:</strong> <span id="contract-status">Pending Signatures</span></p>
          
          <div class="signature-progress">
            <div class="signature-step">
              <span class="step-icon" id="owner-sign-icon">‚è≥</span>
              <span>Car Owner Signature</span>
              <span class="step-status" id="owner-sign-status">Waiting...</span>
            </div>
            <div class="signature-step">
              <span class="step-icon" id="user-sign-icon">‚è≥</span>
              <span>Your Signature</span>
              <span class="step-status" id="user-sign-status">Waiting...</span>
            </div>
          </div>
          
          <div class="signature-actions">
            <button type="button" class="btn-wallet" id="sign-as-user-btn" disabled>
              Sign as User
            </button>
            <button type="button" class="btn-wallet" id="check-signatures-btn">
              Check Status
            </button>
            <button type="button" class="btn-wallet" id="simulate-owner-sign-btn">
              üß™ Simulate Owner Sign (Test)
            </button>
          </div>
        </div>
      </div>
    </form>
  </main>

  <footer>
    <div class="top">
      <div>
        <div class="logo">MORENT</div>
        <p class="desc">Our vision is to provide convenience and help increase your sales business.</p>
      </div>
      <div class="links">
        <div><h4>About</h4><a href="#">How it works</a><a href="#">Featured</a><a href="#">Partnership</a><a href="#">Business Relation</a></div>
        <div><h4>Community</h4><a href="#">Events</a><a href="#">Blog</a><a href="#">Podcast</a><a href="#">Invite a friend</a></div>
        <div><h4>Socials</h4><a href="#">Discord</a><a href="#">Instagram</a><a href="#">Twitter</a><a href="#">Facebook</a></div>
      </div>
    </div>
    <div class="bottom">
      <span>¬©2022 MORENT. All rights reserved</span>
      <div><a href="#">Privacy & Policy</a> | <a href="#">Terms & Condition</a></div>
    </div>
  </footer>

  <!-- ============= SCRIPT ‚Äì WALLET & CPT INTEGRATION ============= -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/dist/ethers.umd.js"></script>
  <script type="module">
    import { AuthManager } from '../js/auth.js';
    window.AuthManager = AuthManager;
  </script>
  <script>
    const CPT_TOKEN_PRICE = 0.000287; // ETH per CPT token
    const CONTRACT_ADDRESSES = {
      CPT_TOKEN: '0x5FbDB2315678afecb367f032d93F642f64180aa3', // Hardhat local deployed CPT token
      FACTORY: '0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512'     // Hardhat local deployed Factory
    };
    
    const API_BASE_URL = 'http://localhost:3000/api';

    let provider = null;
  let currentAccount = null;
  let cptContract = null;
  let ethBalance = 0;
  let cptBalance = 0;
  let carData = null;

  (function () {
    const urlParams = new URLSearchParams(window.location.search);
    const carId = urlParams.get('carId');
    const loadingEl = document.getElementById('loading');
    const formEl = document.getElementById('rentalForm');

    // Check authentication first
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    if (!isLoggedIn) {
      loadingEl.textContent = 'Please login to rent a car';
      loadingEl.style.color = 'red';
      setTimeout(() => {
        window.location.href = 'login.html';
      }, 2000);
      return;
    }

    if (!carId) {
      loadingEl.textContent = 'Error: No car selected!';
      loadingEl.style.color = 'red';
      return;
    }

    console.log('Loading car data for ID:', carId);

    // Initialize wallet with Hardhat local
    initializeWallet();

    // Try different API endpoints for car data
    console.log('Fetching car data from APIs...');
    Promise.all([
      fetch(`http://localhost:3000/api/admin/cars/${carId}`)
        .then(res => {
          console.log('Single car API response status:', res.status);
          return res.json();
        })
        .catch(err => {
          console.error('Single car API error:', err);
          return { success: false, error: err.message };
        }),
      fetch(`http://localhost:3000/api/cars`)
        .then(res => {
          console.log('All cars API response status:', res.status);
          return res.json();
        })
        .catch(err => {
          console.error('All cars API error:', err);
          return [];
        })
    ])
    .then(([singleCarResponse, allCarsResponse]) => {
      let car = null;
      
      // Try to get from single car endpoint (admin format)
      if (singleCarResponse.success && singleCarResponse.car) {
        car = singleCarResponse.car;
        console.log('Car data from single endpoint:', car);
      } 
      // Fallback to search in all cars (public format - direct array)
      else if (Array.isArray(allCarsResponse)) {
        car = allCarsResponse.find(c => c.CarId === carId);
        console.log('Car data from public cars endpoint:', car);
        console.log('Available cars:', allCarsResponse.map(c => c.CarId));
      }
      
      if (!car) {
        throw new Error(`Car with ID ${carId} not found`);
      }
      
      carData = car;

      loadingEl.style.display = 'none';
      formEl.style.display = 'block';
      
      // Update form with car data
      document.getElementById('car-name').value = `${car.CarName || 'Unknown'} (${car.Brand || 'Unknown'})`;

      const rentalAmountCPT = parseFloat(car.PriceRent || 50);
      const purchasePriceCPT = parseFloat(car.PriceBuy || car.PriceRent * 20 || 1000);

      document.getElementById('rental-amount').value = rentalAmountCPT.toFixed(2);
      
      // Store prices for later use
      window.carPrices = {
        rental: rentalAmountCPT,
        purchase: purchasePriceCPT
      };
      
      updateCPTCalculations();

      // Set default dates
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('start-date').value = today;
      document.getElementById('start-date').min = today;

      // Set default time
      const now = new Date();
      document.getElementById('start-time').value =
        `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

      const contractType = document.getElementById('contract-type');
      const endDate = document.getElementById('end-date');
      const endTime = document.getElementById('end-time');
      const paymentOptionsRow = document.getElementById('payment-options-row');
      const paymentType = document.getElementById('payment-type');
      const quarters = document.getElementById('quarters');
      const amountLabel = document.getElementById('amount-label');
      const paymentAmountContainer = document.getElementById('payment-amount-container');
      const rentalAmount = document.getElementById('rental-amount');
      const paymentAmount = document.getElementById('payment-amount');

        const toggleEndFields = () => {
          if(contractType.value === 'purchase'){
            // Disable date/time fields for purchase
            endDate.disabled = true;
            endTime.disabled = true;
            endDate.classList.add('disabled-input');
            endTime.classList.add('disabled-input');
            endDate.removeAttribute('required');
            endTime.removeAttribute('required');
            
            // Show payment options for purchase
            paymentOptionsRow.style.display = 'flex';
            paymentType.setAttribute('required', '');
            amountLabel.textContent = 'Purchase Price (CPT)';
            
            // Update amount to purchase price
            if (window.carPrices) {
              rentalAmount.value = window.carPrices.purchase.toFixed(2);
            }
          } else {
            // Enable date/time fields for rental
            endDate.disabled = false;
            endTime.disabled = false;
            endDate.classList.remove('disabled-input');
            endTime.classList.remove('disabled-input');
            endDate.setAttribute('required','');
            endTime.setAttribute('required','');
            
            // Hide payment options for rental
            paymentOptionsRow.style.display = 'none';
            paymentType.removeAttribute('required');
            paymentAmountContainer.style.display = 'none';
            amountLabel.textContent = 'Rental Amount (CPT)';
            
            // Reset to rental price
            if (window.carPrices) {
              rentalAmount.value = window.carPrices.rental.toFixed(2);
            }
          }
          updateCPTCalculations();
        };
        
        // Payment type change handler
        paymentType.addEventListener('change', function() {
          if (contractType.value === 'purchase') {
            if (this.value === 'quarterly') {
              quarters.disabled = false;
              paymentAmountContainer.style.display = 'block';
              updateQuarterlyPayment();
            } else if (this.value === 'full') {
              quarters.disabled = true;
              paymentAmountContainer.style.display = 'none';
              if (window.carPrices) {
                rentalAmount.value = window.carPrices.purchase.toFixed(2);
              }
            } else {
              quarters.disabled = true;
              paymentAmountContainer.style.display = 'none';
            }
            updateCPTCalculations();
          }
        });
        
        // Quarters change handler
        quarters.addEventListener('change', function() {
          if (contractType.value === 'purchase' && paymentType.value === 'quarterly') {
            updateQuarterlyPayment();
            updateCPTCalculations();
          }
        });
        
        function updateQuarterlyPayment() {
          if (window.carPrices && quarters.value) {
            const quarterlyAmount = window.carPrices.purchase / parseInt(quarters.value);
            paymentAmount.value = quarterlyAmount.toFixed(2);
            rentalAmount.value = quarterlyAmount.toFixed(2); // First payment
          }
        }

        contractType.addEventListener('change', toggleEndFields);
        toggleEndFields();

        formEl.addEventListener('submit', async (e) => {
          e.preventDefault();
          if(!currentAccount){
            alert('Please connect your wallet first!');
            return;
          }

          // Collect form data
          const formData = {
            carId: carId,
            contractType: document.getElementById('contract-type').value,
            startDate: document.getElementById('start-date').value,
            endDate: document.getElementById('end-date').value,
            startTime: document.getElementById('start-time').value,
            endTime: document.getElementById('end-time').value,
            rentalAmount: document.getElementById('rental-amount').value,
            walletAddress: currentAccount,
            note: document.getElementById('note').value
          };
          
          // Add purchase-specific fields
          if (formData.contractType === 'purchase') {
            formData.paymentType = document.getElementById('payment-type').value;
            if (formData.paymentType === 'quarterly') {
              formData.quarters = document.getElementById('quarters').value;
              formData.quarterlyAmount = document.getElementById('payment-amount').value;
            }
            formData.totalPurchasePrice = window.carPrices?.purchase || 0;
          }

          if(formData.contractType === 'purchase'){
            formData.endDate = null;
            formData.endTime = null;
          }

          // ‚úÖ STEP 1: Check CPT Balance
          const totalCPTNeeded = parseFloat(formData.rentalAmount);
          if(cptBalance < totalCPTNeeded){
            const buyMore = confirm(`‚ùå Insufficient CPT balance!
            
Required: ${totalCPTNeeded.toFixed(2)} CPT
Available: ${cptBalance.toFixed(2)} CPT
Need: ${(totalCPTNeeded - cptBalance).toFixed(2)} CPT more

Would you like to buy more CPT tokens now?`);
            
            if (buyMore) {
              await buyTokens();
              return; // Stop here, user needs to buy tokens first
            } else {
              return;
            }
          }

          // ‚úÖ STEP 2: Approve CPT Token Spending
          try {
            await approveCPTSpending(totalCPTNeeded);
          } catch (error) {
            alert('Token approval failed: ' + error.message);
            return;
          }

          // ‚úÖ STEP 3: Create Rental Agreement
          try {
            await createRentalAgreement(formData);
          } catch(error){
            console.error(error);
            alert('Contract creation failed: '+error.message);
          }
        });
      })
      .catch(err=>{
        console.error('Error loading car data:', err);
        loadingEl.textContent = `Error loading car data: ${err.message}`;
        loadingEl.style.color = 'red';
        
        // Fallback to show form with basic data after 3 seconds
        setTimeout(() => {
          loadingEl.style.display = 'none';
          formEl.style.display = 'block';
          
          // Set basic car data
          document.getElementById('car-name').value = `Car #${carId}`;
          document.getElementById('rental-amount').value = '30.00';
          window.carPrices = { rental: 30, purchase: 600 };
          updateCPTCalculations();

          // Set default dates
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('start-date').value = today;
          document.getElementById('start-date').min = today;

          const now = new Date();
          document.getElementById('start-time').value =
            `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

          // Enable basic form functionality
          const contractType = document.getElementById('contract-type');
          const endDate = document.getElementById('end-date');
          const endTime = document.getElementById('end-time');

          const toggleEndFields = () => {
            if(contractType.value === 'purchase'){
              endDate.disabled = true;
              endTime.disabled = true;
              endDate.classList.add('disabled-input');
              endTime.classList.add('disabled-input');
              endDate.removeAttribute('required');
              endTime.removeAttribute('required');
            } else {
              endDate.disabled = false;
              endTime.disabled = false;
              endDate.classList.remove('disabled-input');
              endTime.classList.remove('disabled-input');
              endDate.setAttribute('required','');
              endTime.setAttribute('required','');
            }
          };

          contractType.addEventListener('change', toggleEndFields);
          toggleEndFields();

          // Add form submit handler for fallback mode
          formEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentAccount){
              alert('Please connect your wallet first!');
              return;
            }
            alert('Car data could not be loaded. Please try again later.');
          });
        }, 3000);
      });
  })();

  function initializeWallet(){
    const connectBtn = document.getElementById('connect-wallet-btn');
    const buyTokensBtn = document.getElementById('buy-tokens-btn');

    if(typeof window.ethereum === 'undefined'){
      connectBtn.textContent = 'Install MetaMask';
      connectBtn.onclick = () => window.open('https://metamask.io/', '_blank');
      return;
    }

    provider = new ethers.BrowserProvider(window.ethereum);
    
    // CPT Contract instance with minimal ERC20 ABI
    const cptAbi = [
      "function balanceOf(address owner) view returns (uint256)",
      "function transfer(address to, uint256 amount) returns (bool)"
    ];

    connectBtn.addEventListener('click', connectWallet);
    buyTokensBtn.addEventListener('click', buyTokens);
  }

  async function connectWallet(){
    try {
      const accounts = await window.ethereum.request({ method:'eth_requestAccounts' });
      currentAccount = accounts[0];
      
      // Get signer for contract interactions
      const signer = await provider.getSigner();
      cptContract = new ethers.Contract(CONTRACT_ADDRESSES.CPT_TOKEN, [
        "function balanceOf(address owner) view returns (uint256)",
        "function transfer(address to, uint256 amount) returns (bool)"
      ], signer);
      
      updateWalletUI();
      await loadBalances();
    } catch(error){
      console.error(error);
      alert('Failed to connect wallet: '+error.message);
    }
  }

  function updateWalletUI(){
    const statusDot = document.getElementById('wallet-status-dot');
    const statusText = document.getElementById('wallet-status-text');
    const walletInfo = document.getElementById('wallet-info');
    const connectBtn = document.getElementById('connect-wallet-btn');
    const addressEl = document.getElementById('wallet-address');

    if(currentAccount){
      statusDot.classList.add('connected');
      statusText.textContent = 'Wallet Connected';
      walletInfo.style.display = 'block';
      connectBtn.style.display = 'none';
      addressEl.textContent = currentAccount.substring(0,6)+'...'+currentAccount.substring(38);
    } else {
      statusDot.classList.remove('connected');
      statusText.textContent = 'Wallet not connected';
      walletInfo.style.display = 'none';
      connectBtn.style.display = 'inline-block';
    }
  }

  async function loadBalances(){
    try {
      // Get ETH balance using ethers.js
      const ethBalanceWei = await provider.getBalance(currentAccount);
      ethBalance = parseFloat(ethers.formatEther(ethBalanceWei));
      document.getElementById('eth-balance').textContent = ethBalance.toFixed(4);

      // Get CPT balance from backend API
      const response = await fetch(`${API_BASE_URL}/wallet/cpt-balance/${currentAccount}`);
      const data = await response.json();
      
      if (data.success) {
        cptBalance = parseFloat(data.balance);
        document.getElementById('cpt-balance').textContent = cptBalance.toFixed(2);
      } else {
        console.error('Failed to load CPT balance:', data.error);
        cptBalance = 0;
        document.getElementById('cpt-balance').textContent = '0.00';
      }

      updateCPTCalculations();
    } catch(error){
      console.error('Error loading balances:', error);
    }
  }

  // ‚úÖ CRITICAL: Approve CPT token spending (Standard DApp flow)
  async function approveCPTSpending(amount) {
    try {
      if (!cptContract || !currentAccount) {
        throw new Error('Contract not initialized or wallet not connected');
      }

      const submitBtn = document.querySelector('.btn-submit');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Approving Tokens...';

      // Convert amount to proper units (18 decimals)
      const amountInWei = ethers.parseUnits(amount.toString(), 18);

      // Extended CPT contract ABI with approve function
      const signer = await provider.getSigner();
      const cptContractWithApprove = new ethers.Contract(
        CONTRACT_ADDRESSES.CPT_TOKEN,
        [
          "function balanceOf(address owner) view returns (uint256)",
          "function transfer(address to, uint256 amount) returns (bool)",
          "function approve(address spender, uint256 amount) returns (bool)",
          "function allowance(address owner, address spender) view returns (uint256)"
        ],
        signer
      );

      // Check current allowance
      const currentAllowance = await cptContractWithApprove.allowance(
        currentAccount, 
        CONTRACT_ADDRESSES.FACTORY
      );

      console.log('Current allowance:', ethers.formatUnits(currentAllowance, 18));
      console.log('Required amount:', amount);

      // If allowance is sufficient, skip approval
      if (currentAllowance >= amountInWei) {
        console.log('‚úÖ Sufficient allowance already exists');
        alert('‚úÖ Token spending already approved!');
        return;
      }

      // Request approval for factory contract to spend CPT tokens
      console.log('Requesting approval for:', {
        spender: CONTRACT_ADDRESSES.FACTORY,
        amount: amountInWei.toString()
      });

      const approveTx = await cptContractWithApprove.approve(
        CONTRACT_ADDRESSES.FACTORY, // Factory contract can spend CPT
        amountInWei                  // Amount to approve
      );

      alert(`üîÑ Approval transaction submitted!
      
Hash: ${approveTx.hash}
Please wait for confirmation...`);

      // Wait for approval confirmation
      const receipt = await approveTx.wait();

      console.log('Approval confirmed:', receipt);

      alert(`‚úÖ CPT spending approved successfully!
      
Transaction Hash: ${receipt.hash}
Approved Amount: ${amount} CPT
Gas Used: ${receipt.gasUsed.toString()}

You can now proceed with the rental agreement.`);

    } catch (error) {
      console.error('Approval failed:', error);
      throw new Error(`Token approval failed: ${error.message}`);
    } finally {
      const submitBtn = document.querySelector('.btn-submit');
      submitBtn.disabled = false;
      submitBtn.textContent = 'T·∫°o h·ª£p ƒë·ªìng';
    }
  }

  async function buyTokens(){
    try{
      const rentalCPT = parseFloat(document.getElementById('rental-amount').value || 0);
      const totalCPTNeeded = rentalCPT;
      const cptToBuy = totalCPTNeeded - cptBalance;
      const ethRequired = cptToBuy * CPT_TOKEN_PRICE;

      if(ethBalance < ethRequired){
        alert(`Insufficient ETH. Need ${ethRequired.toFixed(6)} ETH`);
        return;
      }

      // Hardhat ERC20 mint simulation: user sends ETH to CPT contract
      // Here we mock: call transfer function if implemented buyTokens
      alert(`Buying ${cptToBuy.toFixed(2)} CPT for ${ethRequired.toFixed(6)} ETH`);
      console.log('Buying tokens:', {cptToBuy, ethRequired});

      // Mock update balances
      cptBalance += cptToBuy;
      ethBalance -= ethRequired;
      document.getElementById('cpt-balance').textContent = cptBalance.toFixed(2);
      document.getElementById('eth-balance').textContent = ethBalance.toFixed(4);
      updateCPTCalculations();

    } catch(error){
      console.error(error);
      alert('Failed to buy tokens: '+error.message);
    }
  }

  async function createRentalAgreement(formData){
    try {
      const submitBtn = document.querySelector('.btn-submit');
      const originalText = submitBtn.textContent;
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating Contract...';
      
      console.log('Creating rental agreement with data:', formData);

      // Option 1: Call backend API (current implementation)
      const useBackend = true; // Set to false to use direct contract call
      
      if (useBackend) {
        // Backend handles the contract interaction
        const response = await fetch(`${API_BASE_URL}/rental/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to create rental agreement');
        }
        
        // Success notification
        alert(`üéâ Rental agreement created successfully!
        
Contract ID: ${result.data.contractId}
Transaction Hash: ${result.data.txHash}
Agreement Address: ${result.data.agreementAddress}
Gas Used: ${result.data.gasUsed}

${result.data.pdf ? `üìÑ CONTRACT PDF CREATED:
IPFS Hash: ${result.data.pdf.ipfsHash}
PDF URL: ${result.data.pdf.pinataUrl}
File Size: ${Math.round(result.data.pdf.size / 1024)} KB` : ''}

${result.data.metadata ? `üìã METADATA STORED:
IPFS Hash: ${result.data.metadata.ipfsHash}
Metadata URL: ${result.data.metadata.pinataUrl}` : ''}

The contract has been deployed to the blockchain and PDF stored on IPFS.`);

        console.log('Rental agreement created:', result.data);
        
      } else {
        // Option 2: Direct contract call from frontend
        await createRentalContractDirect(formData);
      }
      
      // Optionally redirect to contracts page
      const redirect = confirm('Would you like to view your contracts now?');
      if (redirect) {
        window.location.href = 'my_contracts.html';
      }
      
    } catch (error) {
      console.error('Error creating rental agreement:', error);
      throw error;
    } finally {
      const submitBtn = document.querySelector('.btn-submit');
      submitBtn.disabled = false;
      submitBtn.textContent = 'T·∫°o h·ª£p ƒë·ªìng';
    }
  }

  // Direct smart contract interaction (alternative to backend API)
  async function createRentalContractDirect(formData) {
    try {
      if (!provider || !currentAccount) {
        throw new Error('Please connect your wallet first');
      }

      // Get signer for transaction
      const signer = await provider.getSigner();
      
      // Factory contract instance
      const factoryAbi = [
        "function createAgreement(address _user, address _token, uint256 _vehicleId, uint256 _rentAmount, uint256 _depositAmount) returns (address)",
        "event AgreementCreated(address indexed agreement, address indexed owner, address indexed user)"
      ];
      
      const factoryContract = new ethers.Contract(
        CONTRACT_ADDRESSES.FACTORY, 
        factoryAbi, 
        signer
      );

      // Convert amounts to proper units (assuming 18 decimals)
      const rentalAmount = ethers.parseUnits(formData.rentalAmount.toString(), 18);
      const vehicleId = ethers.hashMessage(formData.carId); // Convert carId to bytes32

      console.log('Calling createAgreement with:', {
        user: currentAccount,
        token: CONTRACT_ADDRESSES.CPT_TOKEN,
        vehicleId: vehicleId,
        rentAmount: rentalAmount.toString(),
        depositAmount: '0'
      });

      // ‚úÖ STEP 1: Estimate gas first
      const gasEstimate = await factoryContract.createAgreement.estimateGas(
        currentAccount,
        CONTRACT_ADDRESSES.CPT_TOKEN,
        vehicleId,
        rentalAmount,
        ethers.parseUnits('0', 18) // No deposit
      );

      console.log('Estimated gas:', gasEstimate.toString());

      // ‚úÖ STEP 2: Call the createAgreement function
      const tx = await factoryContract.createAgreement(
        currentAccount,                    // _user (current user)
        CONTRACT_ADDRESSES.CPT_TOKEN,     // _token (CPT token address)
        vehicleId,                        // _vehicleId (car ID as bytes32)
        rentalAmount,                     // _rentAmount
        ethers.parseUnits('0', 18),       // _depositAmount (no deposit)
        {
          gasLimit: gasEstimate * 120n / 100n // 20% buffer
        }
      );

      console.log('Transaction submitted:', tx.hash);
      alert(`üîÑ Contract creation transaction submitted!
      
Hash: ${tx.hash}
Please wait for confirmation...`);

      // ‚úÖ STEP 3: Wait for transaction confirmation
      const receipt = await tx.wait();
      
      console.log('Transaction confirmed:', receipt);
      
      // ‚úÖ STEP 4: Extract agreement address from events
      let agreementAddress = 'Unknown';
      
      for (const log of receipt.logs) {
        try {
          const decoded = factoryContract.interface.parseLog({
            topics: log.topics,
            data: log.data
          });
          
          if (decoded.name === 'AgreementCreated') {
            agreementAddress = decoded.args.agreement;
            console.log('New agreement created at:', agreementAddress);
            break;
          }
        } catch (error) {
          // Skip unparseable logs
          continue;
        }
      }

      let alertMessage = `üéâ ${formData.contractType === 'purchase' ? 'Purchase' : 'Rental'} agreement created successfully!

‚úÖ Contract deployed to blockchain!
üìç Agreement Address: ${agreementAddress}
üîó Transaction Hash: ${receipt.hash}
‚õΩ Gas Used: ${receipt.gasUsed.toString()}
üì¶ Block Number: ${receipt.blockNumber}

üí∞ ${formData.rentalAmount} CPT ${formData.contractType === 'purchase' ? 'payment' : 'rental fee'} locked`;
      
      if (formData.contractType === 'purchase') {
        if (formData.paymentType === 'quarterly') {
          alertMessage += `

üìã PAYMENT PLAN DETAILS:
üî¢ Total Price: ${formData.totalPurchasePrice} CPT
üìÖ Payment Terms: ${formData.quarters} quarters (${formData.quarters * 3} months)
üí∞ Amount per Quarter: ${formData.quarterlyAmount} CPT
‚úÖ First Payment: ${formData.quarterlyAmount} CPT (Completed)
‚è≥ Next Payments: ${formData.quarters - 1} remaining payments

‚ö†Ô∏è  IMPORTANT: You need to make quarterly payments manually. 
    Contract status will be 'Active' until all payments completed.`;
        } else {
          alertMessage += `
üí∞ Full Purchase Price: ${formData.totalPurchasePrice} CPT (Paid in full)`;
        }
      }
      
      alertMessage += `

The smart contract is now active on the blockchain!`;
      
      alert(alertMessage);

      // ‚úÖ STEP 5: Store contract info in database via API
      try {
        await fetch(`${API_BASE_URL}/rental/store-contract`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contractAddress: agreementAddress,
            txHash: receipt.hash,
            carId: formData.carId,
            userId: localStorage.getItem('userId'),
            walletAddress: currentAccount,
            rentalAmount: formData.rentalAmount,
            contractType: formData.contractType,
            startDate: formData.startDate,
            endDate: formData.endDate,
            blockNumber: receipt.blockNumber,
            gasUsed: receipt.gasUsed.toString(),
            // L∆∞u payment info v√†o note ƒë·ªÉ tham kh·∫£o
            note: formData.contractType === 'purchase' && formData.paymentType === 'quarterly' 
              ? `Quarterly payment: ${formData.quarters} quarters, ${formData.quarterlyAmount} CPT per quarter, Total: ${formData.totalPurchasePrice} CPT`
              : (formData.note || '')
          })
        });
      } catch (dbError) {
        console.warn('Failed to store contract info in database:', dbError);
      }

      return {
        txHash: receipt.hash,
        agreementAddress: agreementAddress,
        gasUsed: receipt.gasUsed.toString(),
        blockNumber: receipt.blockNumber
      };

    } catch (error) {
      console.error('Direct contract call failed:', error);
      throw new Error(`Contract creation failed: ${error.message}`);
    }
  }

  function updateCPTCalculations(){
    const rentalCPT = parseFloat(document.getElementById('rental-amount').value || 0);
    const totalCPT = rentalCPT;
    const totalETH = totalCPT * CPT_TOKEN_PRICE;

    document.getElementById('total-cpt-needed').textContent = totalCPT.toFixed(2);
    document.getElementById('total-eth-cost').textContent = totalETH.toFixed(6);

    const insufficientEl = document.getElementById('insufficient-balance');
    const sufficientEl = document.getElementById('sufficient-balance');
    if(currentAccount){
      if(cptBalance >= totalCPT){
        insufficientEl.style.display = 'none';
        sufficientEl.style.display = 'block';
      } else {
        insufficientEl.style.display = 'block';
        sufficientEl.style.display = 'none';
      }
    }
  }

  // ===== SIGNATURE MANAGEMENT FUNCTIONS =====
  
  let currentContractAddress = null;
  
  function showSignatureSection(contractAddress) {
    currentContractAddress = contractAddress;
    
    const signatureSection = document.getElementById('signature-section');
    const contractAddressDisplay = document.getElementById('contract-address-display');
    
    contractAddressDisplay.textContent = contractAddress;
    signatureSection.style.display = 'block';
    
    // Setup event listeners
    document.getElementById('sign-as-user-btn').addEventListener('click', signAsUser);
    document.getElementById('check-signatures-btn').addEventListener('click', checkSignatureStatus);
    document.getElementById('simulate-owner-sign-btn').addEventListener('click', simulateOwnerSign);
    
    // Initial status check
    checkSignatureStatus();
    
    // Hide form submit button
    document.querySelector('.btn-submit').style.display = 'none';
  }
  
  async function checkSignatureStatus() {
    try {
      if (!currentContractAddress || !provider) return;
      
      const signer = await provider.getSigner();
      const agreementAbi = [
        "function ownerSigned() view returns (bool)",
        "function userSigned() view returns (bool)",
        "function status() view returns (uint8)",
        "function owner() view returns (address)",
        "function user() view returns (address)"
      ];
      
      const agreementContract = new ethers.Contract(
        currentContractAddress,
        agreementAbi,
        signer
      );
      
      const [ownerSigned, userSigned, status, owner, user] = await Promise.all([
        agreementContract.ownerSigned(),
        agreementContract.userSigned(),
        agreementContract.status(),
        agreementContract.owner(),
        agreementContract.user()
      ]);
      
      console.log('Signature status:', { ownerSigned, userSigned, status, owner, user });
      
      // Update UI
      updateSignatureUI(ownerSigned, userSigned, status);
      
      // Enable user sign button if owner signed and user hasn't
      const signUserBtn = document.getElementById('sign-as-user-btn');
      signUserBtn.disabled = !ownerSigned || userSigned;
      
      if (ownerSigned && userSigned) {
        document.getElementById('contract-status').textContent = 'Active ‚úÖ';
        alert('üéâ Contract is now ACTIVE! Both parties have signed.');
      }
      
    } catch (error) {
      console.error('Error checking signature status:', error);
    }
  }
  
  function updateSignatureUI(ownerSigned, userSigned, status) {
    // Update owner signature status
    const ownerIcon = document.getElementById('owner-sign-icon');
    const ownerStatus = document.getElementById('owner-sign-status');
    
    if (ownerSigned) {
      ownerIcon.textContent = '‚úÖ';
      ownerStatus.textContent = 'Signed';
      ownerStatus.className = 'step-status signed';
    } else {
      ownerIcon.textContent = '‚è≥';
      ownerStatus.textContent = 'Waiting...';
      ownerStatus.className = 'step-status pending';
    }
    
    // Update user signature status
    const userIcon = document.getElementById('user-sign-icon');
    const userStatus = document.getElementById('user-sign-status');
    
    if (userSigned) {
      userIcon.textContent = '‚úÖ';
      userStatus.textContent = 'Signed';
      userStatus.className = 'step-status signed';
    } else {
      userIcon.textContent = '‚è≥';
      userStatus.textContent = 'Waiting...';
      userStatus.className = 'step-status pending';
    }
  }
  
  async function signAsUser() {
    try {
      if (!currentContractAddress || !provider) {
        throw new Error('Contract not initialized');
      }
      
      const submitBtn = document.getElementById('sign-as-user-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Signing...';
      
      const signer = await provider.getSigner();
      const agreementAbi = [
        "function signAgreementAsUser(uint256 _durationDays, uint256 _intervalDays)"
      ];
      
      const agreementContract = new ethers.Contract(
        currentContractAddress,
        agreementAbi,
        signer
      );
      
      // Calculate rental duration (example: 30 days with 30-day intervals)
      const durationDays = 30;
      const intervalDays = 30;
      
      console.log('Signing as user with duration:', durationDays, 'interval:', intervalDays);
      
      const tx = await agreementContract.signAgreementAsUser(durationDays, intervalDays);
      
      alert(`üîÑ Signing transaction submitted!
      
Hash: ${tx.hash}
Please wait for confirmation...`);
      
      const receipt = await tx.wait();
      
      alert(`‚úÖ Successfully signed as User!
      
Transaction Hash: ${receipt.hash}
Gas Used: ${receipt.gasUsed.toString()}

Waiting for Car Owner signature...`);
      
      // Refresh status
      setTimeout(() => checkSignatureStatus(), 2000);
      
    } catch (error) {
      console.error('User signature failed:', error);
      alert('Signature failed: ' + error.message);
    } finally {
      const submitBtn = document.getElementById('sign-as-user-btn');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Sign as User';
    }
  }
  
  async function simulateOwnerSign() {
    try {
      alert('üß™ Test Mode: Simulating Owner signature...');
      
      // This would normally be done by the car owner
      // For testing purposes, we'll call the backend API
      const response = await fetch(`${API_BASE_URL}/rental/sign-as-owner`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contractAddress: currentContractAddress
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert(`‚úÖ Owner signature simulated!
        
Transaction Hash: ${result.txHash}
        
Now you can sign as User.`);
        
        // Refresh status
        setTimeout(() => checkSignatureStatus(), 2000);
      } else {
        throw new Error(result.error || 'Failed to simulate owner signature');
      }
      
    } catch (error) {
      console.error('Owner signature simulation failed:', error);
      alert('Owner signature simulation failed: ' + error.message);
    }
  }
</script>
</body>
</html>