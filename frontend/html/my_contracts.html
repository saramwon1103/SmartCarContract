<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Contracts | Morent</title>
    <link rel="stylesheet" href="../css/admin_dashboard.css" />
    <link rel="stylesheet" href="../css/my_contracts.css" />
    <link rel="stylesheet" href="../css/owner_confirmation.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
      .wallet-section {
        margin-bottom: 20px;
      }
      
      .wallet-card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid #e5e7eb;
      }
      
      .wallet-status {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      
      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #ef4444;
        transition: background 0.3s;
      }
      
      .status-dot.connected {
        background: #10b981;
      }
      
      .btn-connect {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
      }
      
      .btn-connect:hover {
        background: #2563eb;
      }
      
      .wallet-info {
        border-top: 1px solid #e5e7eb;
        padding-top: 15px;
      }
      
      .wallet-address {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-family: monospace;
        font-size: 14px;
      }
      
      .wallet-balances {
        display: flex;
        gap: 20px;
      }
      
      .balance-item {
        display: flex;
        justify-content: space-between;
        min-width: 100px;
        font-weight: 500;
      }
      
      .payment-section {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #f9fafb;
      }
      
      .payment-info {
        margin-bottom: 15px;
      }
      
      .payment-amount {
        font-size: 18px;
        font-weight: bold;
        color: #059669;
        margin: 10px 0;
      }
      
      .btn-pay {
        background: #059669;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s;
        width: 100%;
      }
      
      .btn-pay:hover:not(:disabled) {
        background: #047857;
      }
      
      .btn-pay:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Fixed Sidebar -->
      <aside class="sidebar">
        <h2 class="logo">MORENT</h2>
        <nav class="menu" id="sidebar-menu">
          <!-- Menu will be populated based on user role -->
        </nav>
        <div class="sidebar-footer">
          <a href="#" id="logoutBtn" class="logout-link">
            <i class="fa-solid fa-right-from-bracket icon" style="color: #90A3BF;"></i> Log out
          </a>
        </div>
      </aside>

      <main class="main">
        <header class="topbar">
          <div class="search">
            <input id="searchContracts" type="text" placeholder="Search contract id, car, customer..." />
            <span class="filter"><img src="../image/search.svg" alt="Search" class="icon"></span>
          </div>
          <div class="user-icons">
            <img src="https://i.pravatar.cc/40" alt="avatar" class="avatar" />
          </div>
        </header>

        <section class="content">
          <!-- Wallet Connection Section -->
          <div class="wallet-section">
            <div class="wallet-card">
              <div class="wallet-status">
                <div class="status-indicator">
                  <div id="wallet-status-dot" class="status-dot"></div>
                  <span id="wallet-status-text">Wallet not connected</span>
                </div>
                <button id="connect-wallet-btn" class="btn btn-connect">Connect Wallet</button>
                <button id="buy-cpt-btn" class="btn btn-connect" style="display: none; margin-left: 10px; background: #059669;">Buy CPT</button>
              </div>
              
              <div id="wallet-info" class="wallet-info" style="display: none;">
                <div class="wallet-address">
                  <span>Address:</span>
                  <span id="wallet-address">-</span>
                </div>
                <div class="wallet-balances">
                  <div class="balance-item">
                    <span>ETH:</span>
                    <span id="eth-balance">0.0000</span>
                  </div>
                  <div class="balance-item">
                    <span>CPT:</span>
                    <span id="cpt-balance">0.00</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="left-panel left-panel-full">
            <div class="card">
              <div class="header filter-header">
                <h3>My Contracts</h3>
                <div class="filter-controls">
                  <select id="statusFilter" class="status-filter">
                    <option value="">All Status</option>
                    <option value="Pending">Pending</option>
                    <option value="Active">Active</option>
                    <option value="Completed">Completed</option>
                    <option value="Terminated">Terminated</option>
                  </select>
                  <button id="refreshBtn" class="btn-primary">Refresh</button>
                </div>
              </div>

              <!-- Stats Cards -->
              <div class="stats-grid">
                <div class="stat-card">
                  <p>Total Contracts</p>
                  <h4 id="totalContracts">0</h4>
                </div>
                <div class="stat-card">
                  <p>Active</p>
                  <h4 id="activeContracts">0</h4>
                </div>
                <div class="stat-card">
                  <p>Pending</p>
                  <h4 id="pendingContracts">0</h4>
                </div>
                <div class="stat-card">
                  <p>Completed</p>
                  <h4 id="completedContracts">0</h4>
                </div>
              </div>

              <!-- Contracts Table -->
              <div class="table-container">
                <table id="contractsTable" class="contract-table">
                  <thead>
                    <tr>
                      <th>Contract ID</th>
                      <th>Car</th>
                      <th>Type</th>
                      <th>Period</th>
                      <th>Status</th>
                      <th>Total Price</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="contractsTableBody">
                    <tr><td colspan="7" class="table-empty">Loading contracts...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- RIGHT PANEL - Contract Details -->
          <div class="right-panel">
            <div class="card rental-details" id="contractDetails">
              <h3>Contract Details</h3>
              <div class="car-box">
                <img id="detailCarImage" src="" alt="Car image">
                <div>
                  <h4 id="detailCarName">-</h4>
                  <p id="detailCarType">-</p>
                </div>
              </div>
              
              <div class="contract-details-info">
                <div class="contract-basic-info">
                  <h5>Basic Information</h5>
                  <p>Contract ID: <span id="detailContractId">-</span></p>
                  <p>Type: <span id="detailContractType">-</span></p>
                  <p>Transaction: <span id="detailTXHash">-</span></p>
                  <p>Start Date: <span id="detailStartDate">-</span></p>
                  <p>End Date: <span id="detailEndDate">-</span></p>
                </div>
                
                <div class="contract-counterparty-info">
                  <h5>Counterparty Information</h5>
                  <p>Name: <span id="detailCounterpartyName">-</span></p>
                  <p>Email: <span id="detailCounterpartyEmail">-</span></p>
                </div>
                
                <div class="contract-payment-info">
                  <h5>Payment Information</h5>
                  <p>Installment Amount: <span id="detailInstallmentAmount">-</span></p>
                  <p>Paid Periods: <span id="detailPaidPeriods">-</span> / <span id="detailTotalPeriods">-</span></p>
                  <p>Next Payment Due: <span id="detailNextPayment">-</span></p>
                </div>
                
                <div class="total-price">
                  <p>Total Price</p>
                  <h3 id="detailTotalPrice">-</h3>
                </div>
                
                <!-- Payment Section -->
                <div id="payment-section" class="payment-section" style="display: none;">
                  <h5>ðŸ’³ Make Payment</h5>
                  <div class="payment-info">
                    <p>You need to complete payment to activate this contract.</p>
                    <div class="payment-amount">
                      Pay: <span id="payment-amount">$0.00</span> in CPT tokens
                    </div>
                  </div>
                  <button id="make-payment-btn" class="btn-pay" disabled>Connect Wallet to Pay</button>
                </div>
                
                <!-- Owner Confirmation Section -->
                <div id="owner-confirmation-section" class="payment-section" style="display: none; background: #fff3cd;">
                  <h5>ðŸ”¸ Owner Action Required</h5>
                  <div class="payment-info">
                    <p>As the car owner, you need to confirm this contract request.</p>
                  </div>
                  <div style="display: flex; gap: 10px;">
                    <button id="approve-contract-btn" class="btn-pay" style="background: #28a745;">Approve Contract</button>
                    <button id="reject-contract-btn" class="btn-pay" style="background: #dc3545;">Reject Contract</button>
                  </div>
                </div>
                
                <!-- Owner Payment Confirmation Section -->
                <div id="owner-payment-confirmation-section" class="payment-section" style="display: none; background: #d1ecf1;">
                  <h5>ðŸ’° Payment Received Confirmation</h5>
                  <div class="payment-info">
                    <p>User has paid <span id="paid-amount">$0.00</span> CPT. Please check your wallet and confirm payment received.</p>
                  </div>
                  <button id="confirm-payment-received-btn" class="btn-pay" style="background: #17a2b8;">Confirm Payment Received</button>
                </div>
                
                <div class="contract-actions">
                  <button id="payBtn" class="btn-primary">Pay Installment</button>
                  <button id="viewOnChain" class="btn-secondary">View on Blockchain</button>
                </div>
              </div>

              <!-- Empty State -->
              <div class="card" id="emptyState">
                <p>Select a contract to view details</p>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/contract-notifications.js"></script>
    
    <script>
      // Initialize page
      document.addEventListener('DOMContentLoaded', () => {
        console.log('My Contracts page loaded');
        
        // Load appropriate menu based on user role
        const user = AuthManager.getCurrentUser();
        const sidebarMenu = document.getElementById('sidebar-menu');
        
        if (user && user.Role === 'Owner') {
          // Owner menu
          sidebarMenu.innerHTML = `
            <a href="#" data-page="home" data-url="owner_home.html">
              <img src="../image/home.svg" class="icon" alt="Home icon"> Home
            </a>
            <a href="#" data-page="cars" data-url="owner_car.html">
              <img src="../image/car.svg" class="icon" alt="Cars icon"> My Cars
            </a>
            <a href="#" data-page="contracts" data-url="my_contracts.html" class="active">
              <img src="../image/heart.svg" class="icon" alt="Contracts icon"> Contracts
            </a>
            <a href="#" data-page="profile" data-url="profile.html">
              <img src="../image/person.svg" class="icon" alt="Profile icon"> Profile
            </a>
          `;
        } else {
          // User menu
          sidebarMenu.innerHTML = `
            <a href="#" data-page="home" data-url="home.html">
              <img src="../image/home.svg" class="icon" alt="Home icon"> Home
            </a>
            <a href="#" data-page="contracts" data-url="my_contracts.html" class="active">
              <img src="../image/car.svg" class="icon" alt="Contracts icon"> My Contracts
            </a>
            <a href="#" data-page="profile" data-url="profile.html">
              <img src="../image/person.svg" class="icon" alt="Profile icon"> Profile
            </a>
          `;
        }
        
        // Setup navigation
        const navLinks = document.querySelectorAll('.sidebar .menu a[data-url]');
        navLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const url = this.getAttribute('data-url');
            if (url && url !== window.location.pathname.split('/').pop()) {
              window.location.href = url;
            }
          });
        });
        
        // Setup logout
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Clear wallet connection before logout
            clearWalletConnection();
            
            if (typeof AuthManager !== 'undefined' && AuthManager.logout) {
              AuthManager.logout();
            } else {
              localStorage.removeItem('user');
              localStorage.removeItem('isLoggedIn');
              window.location.href = 'login.html';
            }
          });
        }
      });
      
      // Clear wallet connection
      function clearWalletConnection() {
        currentAccount = null;
        provider = null;
        cptContract = null;
        ethBalance = 0;
        cptBalance = 0;
        updateWalletUI();
        updatePaymentSection();
        console.log('Wallet connection cleared');
      }
      
      // Buy CPT with ETH
      async function showBuyCptModal() {
        if (!currentAccount) {
          alert('Please connect your wallet first');
          return;
        }

        try {
          // Get exchange rate from API (which gets it from CarPayToken contract)
          const rateResponse = await fetch(`${API_BASE_URL}/wallet/exchange-rate`);
          const rateData = await rateResponse.json();
          
          if (!rateData.success) {
            throw new Error('Failed to get exchange rate from CarPayToken contract');
          }
          
          const cptForOneETH = rateData.cptForOneETH;
          const ethForOneCPT = rateData.ethForOneCPT;
          
          const ethAmount = prompt(`Enter ETH amount to spend (e.g., 0.1):\n\nCurrent rate from CarPayToken contract:\n1 ETH = ${cptForOneETH.toFixed(2)} CPT\n1 CPT = ${ethForOneCPT.toFixed(6)} ETH`);
          
          if (!ethAmount || isNaN(ethAmount) || parseFloat(ethAmount) <= 0) {
            return;
          }
          
          const expectedCptAmount = parseFloat(ethAmount) * cptForOneETH;
          
          const confirmed = confirm(`Purchase ${expectedCptAmount.toFixed(2)} CPT with ${ethAmount} ETH?\n\nUsing CarPayToken contract rate:\n1 ETH = ${cptForOneETH.toFixed(2)} CPT`);
          if (!confirmed) return;
          
          await buyCptWithEth(parseFloat(ethAmount), expectedCptAmount);
          
        } catch (error) {
          console.error('Error in buy CPT process:', error);
          alert('Failed to buy CPT: ' + error.message);
        }
      }

      async function buyCptWithEth(ethAmount, expectedCptAmount) {
        try {
          // Call CarPayToken contract's buyTokens function
          const signer = await provider.getSigner();
          const cptContractWithSigner = new ethers.Contract(
            CONTRACT_ADDRESSES.CPT_TOKEN, 
            [
              "function balanceOf(address owner) view returns (uint256)",
              "function transfer(address to, uint256 amount) returns (bool)",
              "function approve(address spender, uint256 amount) returns (bool)",
              "function tokenPrice() view returns (uint256)",
              "function buyTokens() payable"
            ], 
            signer
          );
          
          // Send ETH to buyTokens function
          const tx = await cptContractWithSigner.buyTokens({
            value: ethers.parseEther(ethAmount.toString()),
            gasLimit: 100000
          });
          
          console.log('Buy CPT transaction sent:', tx.hash);
          await tx.wait();
          
          // Call API to verify and record purchase
          const response = await fetch(`${API_BASE_URL}/wallet/buy-cpt`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userWalletAddress: currentAccount,
              ethAmount,
              txHash: tx.hash
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert(`âœ… Successfully purchased ${result.transaction.cptAmount.toFixed(2)} CPT with ${ethAmount} ETH!`);
            await loadBalances();
          } else {
            throw new Error(result.error);
          }
          
        } catch (error) {
          console.error('CPT purchase error:', error);
          throw error;
        }
      }
    </script>
    <script src="../js/my_contracts.js"></script>
    
    <script>
      // Wallet Connection Logic
      let provider = null;
      let currentAccount = null;
      let cptContract = null;
      let ethBalance = 0;
      let cptBalance = 0;
      
      const API_BASE_URL = 'http://localhost:3000/api';
      
      const CONTRACT_ADDRESSES = {
        CPT_TOKEN: '0x5fbdb2315678afecb367f032d93f642f64180aa3', // Update with actual deployed address
        RENTAL_FACTORY: '0xe7f1725e7734ce288f8367e1bb143e90bb3f0512' // Update with actual deployed address
      };
      
      document.addEventListener('DOMContentLoaded', () => {
        console.log('My Contracts page loaded, initializing wallet...');
        // Initialize wallet after a small delay to ensure DOM is ready
        setTimeout(() => {
          initializeWallet();
        }, 500);
      });
      
      function initializeWallet() {
        console.log('Initializing wallet connection...');
        const connectBtn = document.getElementById('connect-wallet-btn');
        const buyCptBtn = document.getElementById('buy-cpt-btn');
        const makePaymentBtn = document.getElementById('make-payment-btn');
        
        console.log('Wallet buttons found:', {
          connectBtn: !!connectBtn,
          buyCptBtn: !!buyCptBtn,
          makePaymentBtn: !!makePaymentBtn
        });
        
        if (!connectBtn) {
          console.error('Connect wallet button not found!');
          return;
        }
        
        if (typeof window.ethereum === 'undefined') {
          console.log('MetaMask not detected');
          connectBtn.textContent = 'Install MetaMask';
          connectBtn.onclick = () => window.open('https://metamask.io/', '_blank');
          return;
        }
        
        console.log('MetaMask detected, setting up provider...');
        provider = new ethers.BrowserProvider(window.ethereum);
        
        connectBtn.addEventListener('click', connectWallet);
        
        if (buyCptBtn) {
          buyCptBtn.addEventListener('click', showBuyCptModal);
        }
        
        if (makePaymentBtn) {
          console.log('Setting up makePaymentBtn click handler');
          makePaymentBtn.addEventListener('click', makeContractPayment);
        }
        
        // Check if already connected
        checkExistingConnection();
      }
      
      async function checkExistingConnection() {
        try {
          // Kiá»ƒm tra user hiá»‡n táº¡i cÃ³ wallet hay chÆ°a
          const currentUser = AuthManager.getCurrentUser();
          if (!currentUser) {
            console.log('No user logged in, skipping wallet check');
            return;
          }

          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          if (accounts.length > 0) {
            const connectedWallet = accounts[0].toLowerCase();
            
            // Kiá»ƒm tra xem user cÃ³ wallet trong database khÃ´ng
            try {
              const response = await fetch(`http://localhost:3000/api/users/${currentUser.UserId}/wallet`);
              const walletData = await response.json();
              
              if (walletData.success && walletData.wallet && walletData.wallet.WalletAddress) {
                const userWallet = walletData.wallet.WalletAddress.toLowerCase();
                
                // Chá»‰ auto-connect náº¿u wallet khá»›p
                if (connectedWallet === userWallet) {
                  currentAccount = accounts[0];
                  await setupWalletConnection();
                  console.log('Auto-connected to user wallet:', currentAccount);
                } else {
                  console.log('MetaMask wallet does not match user wallet');
                  // Clear connection náº¿u khÃ´ng khá»›p
                  currentAccount = null;
                  updateWalletUI();
                }
              } else {
                console.log('User has no wallet registered');
              }
            } catch (error) {
              console.error('Error checking user wallet:', error);
            }
          }
        } catch (error) {
          console.error('Error checking existing connection:', error);
        }
      }
      
      async function connectWallet() {
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          currentAccount = accounts[0];
          
          // Save wallet to database
          await saveWalletToDatabase(currentAccount);
          
          await setupWalletConnection();
          
          console.log('Wallet connected and saved:', currentAccount);
        } catch (error) {
          console.error('Error connecting wallet:', error);
          alert('Failed to connect wallet: ' + error.message);
        }
      }
      
      async function saveWalletToDatabase(walletAddress) {
        try {
          const currentUser = AuthManager.getCurrentUser();
          if (!currentUser) {
            throw new Error('No user logged in');
          }

          const response = await fetch(`http://localhost:3000/api/users/${currentUser.UserId}/wallet`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              walletAddress: walletAddress,
              network: 'Hardhat'
            })
          });

          const result = await response.json();
          if (!result.success) {
            throw new Error(result.error || 'Failed to save wallet');
          }
          
          console.log('Wallet saved to database successfully');
        } catch (error) {
          console.error('Error saving wallet to database:', error);
          // Don't throw error, just log it - wallet still works locally
        }
      }
      
      async function setupWalletConnection() {
        try {
          const signer = await provider.getSigner();
          
          // Setup CPT contract
          const cptAbi = [
            "function balanceOf(address owner) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function approve(address spender, uint256 amount) returns (bool)"
          ];
          
          cptContract = new ethers.Contract(CONTRACT_ADDRESSES.CPT_TOKEN, cptAbi, signer);
          
          updateWalletUI();
          await loadBalances();
          
          // Update payment section after wallet connection
          setTimeout(updatePaymentSection, 200);
        } catch (error) {
          console.error('Error setting up wallet connection:', error);
        }
      }
      
      function updateWalletUI() {
        console.log('Updating wallet UI, current account:', currentAccount);
        const statusDot = document.getElementById('wallet-status-dot');
        const statusText = document.getElementById('wallet-status-text');
        const walletInfo = document.getElementById('wallet-info');
        const connectBtn = document.getElementById('connect-wallet-btn');
        const buyCptBtn = document.getElementById('buy-cpt-btn');
        const addressEl = document.getElementById('wallet-address');
        
        console.log('UI Elements found:', {
          statusDot: !!statusDot,
          statusText: !!statusText, 
          walletInfo: !!walletInfo,
          connectBtn: !!connectBtn,
          buyCptBtn: !!buyCptBtn,
          addressEl: !!addressEl
        });
        
        if (currentAccount) {
          console.log('Setting connected state...');
          statusDot.classList.add('connected');
          statusText.textContent = 'Wallet Connected';
          walletInfo.style.display = 'block';
          connectBtn.style.display = 'none';
          buyCptBtn.style.display = 'inline-block';
          addressEl.textContent = currentAccount.substring(0, 6) + '...' + currentAccount.substring(38);
        } else {
          console.log('Setting disconnected state...');
          statusDot.classList.remove('connected');
          statusText.textContent = 'Wallet not connected';
          walletInfo.style.display = 'none';
          connectBtn.style.display = 'inline-block';
          buyCptBtn.style.display = 'none';
        }
      }
      
      async function loadBalances() {
        try {
          // Get ETH balance
          const ethBalanceWei = await provider.getBalance(currentAccount);
          ethBalance = parseFloat(ethers.formatEther(ethBalanceWei));
          document.getElementById('eth-balance').textContent = ethBalance.toFixed(4);
          
          // Try to get CPT balance from backend API first
          try {
            const response = await fetch(`${API_BASE_URL}/wallet/cpt-balance/${currentAccount}`);
            const data = await response.json();
            
            if (data.success) {
              cptBalance = parseFloat(data.balance);
              document.getElementById('cpt-balance').textContent = cptBalance.toFixed(2);
              console.log('CPT balance from API:', cptBalance);
            } else {
              throw new Error(data.error || 'API failed');
            }
          } catch (apiError) {
            console.warn('Failed to load CPT balance from API:', apiError);
            // Fallback: set a default balance for testing
            cptBalance = 100.00; // Default test balance
            document.getElementById('cpt-balance').textContent = cptBalance.toFixed(2);
            console.log('Using default CPT balance:', cptBalance);
          }
          
          updatePaymentSection();
        } catch (error) {
          console.error('Error loading balances:', error);
          // Set default values on error
          ethBalance = 0;
          cptBalance = 100; // Default for testing
          document.getElementById('eth-balance').textContent = '0.0000';
          document.getElementById('cpt-balance').textContent = '100.00';
        }
      }
      
      function updatePaymentSection() {
        const makePaymentBtn = document.getElementById('make-payment-btn');
        const paymentSection = document.getElementById('payment-section');
        const ownerConfirmationSection = document.getElementById('owner-confirmation-section');
        const ownerPaymentConfirmationSection = document.getElementById('owner-payment-confirmation-section');
        
        if (!makePaymentBtn || !paymentSection) return;
        
        // Get current contract from contracts manager
        const contract = window.contractsManager?.selectedContract;
        const currentUser = window.AuthManager?.getCurrentUser();
        
        console.log('updatePaymentSection - Contract:', contract);
        console.log('updatePaymentSection - User:', currentUser);
        
        if (!contract || !currentUser) return;
        
        // Hide all sections initially
        paymentSection.style.display = 'none';
        ownerConfirmationSection.style.display = 'none';
        ownerPaymentConfirmationSection.style.display = 'none';
        
        // Check user role and contract status to show appropriate section
        const isOwner = currentUser.Role === 'Owner';
        const contractStatus = contract.Status;
        
        console.log('updatePaymentSection - Status:', contractStatus, 'User role:', currentUser.Role, 'Is Owner:', isOwner);
        
        if (isOwner) {
          // Owner view
          if (contractStatus === 'Pending') {
            // Show owner confirmation section
            ownerConfirmationSection.style.display = 'block';
            setupOwnerConfirmationHandlers(contract);
          } else if (contractStatus === 'Paid') {
            // Show payment received confirmation
            ownerPaymentConfirmationSection.style.display = 'block';
            document.getElementById('paid-amount').textContent = `$${parseFloat(contract.TotalPrice || 0).toFixed(2)}`;
            setupOwnerPaymentConfirmationHandlers(contract);
          }
        } else {
          // User view - show payment section when status is Active
          if (contractStatus === 'Active') {
            console.log('Showing payment section for Active contract');
            paymentSection.style.display = 'block';
            
            const paymentAmount = parseFloat(contract.TotalPrice || 0);
            document.getElementById('payment-amount').textContent = `$${paymentAmount.toFixed(2)}`;
            
            if (currentAccount) {
              console.log('Wallet connected, checking CPT balance:', cptBalance, 'Required:', paymentAmount);
              if (cptBalance >= paymentAmount) {
                makePaymentBtn.disabled = false;
                makePaymentBtn.textContent = `Pay ${paymentAmount.toFixed(2)} CPT`;
                makePaymentBtn.style.background = '#059669';
              } else {
                makePaymentBtn.disabled = true;
                makePaymentBtn.textContent = `Insufficient CPT Balance (${cptBalance.toFixed(2)})`;
                makePaymentBtn.style.background = '#ef4444';
              }
            } else {
              console.log('Wallet not connected');
              makePaymentBtn.disabled = true;
              makePaymentBtn.textContent = 'Connect Wallet to Pay';
              makePaymentBtn.style.background = '#9ca3af';
            }
          } else {
            console.log('Contract status not Active, hiding payment section. Status:', contractStatus);
          }
        }
      }
      
      async function makeContractPayment() {
        const contract = window.contractsManager?.selectedContract;
        if (!contract || !currentAccount || !cptContract) {
          alert('Please select a contract and connect your wallet');
          return;
        }
        
        try {
          const paymentAmount = parseFloat(contract.TotalPrice);
          
          const confirmed = confirm(`Complete payment of ${paymentAmount} CPT for contract ${contract.ContractId}?`);
          if (!confirmed) return;
          
          const makePaymentBtn = document.getElementById('make-payment-btn');
          makePaymentBtn.disabled = true;
          makePaymentBtn.textContent = 'Processing Payment...';
          
          // First approve the CPT spending
          const amountInWei = ethers.parseUnits(paymentAmount.toString(), 18);
          const approveTx = await cptContract.approve(CONTRACT_ADDRESSES.RENTAL_FACTORY, amountInWei);
          console.log('Approval transaction:', approveTx.hash);
          
          await approveTx.wait();
          
          // Transfer CPT to contract or owner (replace demo transaction)
          // Get owner wallet address from contract data
          const contractData = window.contractsManager?.selectedContract;
          if (!contractData || !contractData.OwnerAddress) {
            throw new Error('Cannot find owner wallet address');
          }
          
          const transferTx = await cptContract.transfer(contractData.OwnerAddress, amountInWei);
          console.log('CPT Transfer transaction:', transferTx.hash);
          
          await transferTx.wait();
          console.log('CPT payment completed successfully');
          
          // Call backend to complete payment
          const response = await fetch(`${API_BASE_URL}/contracts/${contract.ContractId}/payment`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userWalletAddress: currentAccount,
              txHash: transferTx.hash,
              paymentAmount: paymentAmount,
              updateStatus: 'Paid' // Update status to Paid after payment
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('âœ… Payment completed successfully! Contract status updated to Paid. Waiting for owner confirmation.');
            window.contractsManager.loadContracts();
            await loadBalances();
          } else {
            throw new Error(result.error || 'Payment failed');
          }
          
        } catch (error) {
          console.error('Payment error:', error);
          alert('Payment failed: ' + error.message);
        } finally {
          updatePaymentSection();
        }
      }
      
      // Setup owner confirmation handlers
      function setupOwnerConfirmationHandlers(contract) {
        const approveBtn = document.getElementById('approve-contract-btn');
        const rejectBtn = document.getElementById('reject-contract-btn');
        
        if (approveBtn && !approveBtn.dataset.handlerSet) {
          approveBtn.dataset.handlerSet = 'true';
          approveBtn.addEventListener('click', () => handleOwnerApproval(contract, 'approve'));
        }
        
        if (rejectBtn && !rejectBtn.dataset.handlerSet) {
          rejectBtn.dataset.handlerSet = 'true';
          rejectBtn.addEventListener('click', () => handleOwnerApproval(contract, 'reject'));
        }
      }
      
      // Setup owner payment confirmation handlers
      function setupOwnerPaymentConfirmationHandlers(contract) {
        const confirmBtn = document.getElementById('confirm-payment-received-btn');
        
        if (confirmBtn && !confirmBtn.dataset.handlerSet) {
          confirmBtn.dataset.handlerSet = 'true';
          confirmBtn.addEventListener('click', () => handleOwnerPaymentConfirmation(contract));
        }
      }
      
      // Handle owner approval/rejection
      async function handleOwnerApproval(contract, action) {
        try {
          const confirmed = confirm(`${action === 'approve' ? 'Approve' : 'Reject'} contract ${contract.ContractId}?`);
          if (!confirmed) return;
          
          const btn = document.getElementById(`${action}-contract-btn`);
          btn.disabled = true;
          btn.textContent = action === 'approve' ? 'Approving...' : 'Rejecting...';
          
          const response = await fetch(`${API_BASE_URL}/contracts/${contract.ContractId}/owner-action`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: action,
              ownerId: window.AuthManager.getCurrentUser().UserId
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert(`âœ… Contract ${action}d successfully!`);
            window.contractsManager?.loadContracts();
            updatePaymentSection();
          } else {
            throw new Error(result.error || `Failed to ${action} contract`);
          }
          
        } catch (error) {
          console.error(`Owner ${action} error:`, error);
          alert(`Failed to ${action} contract: ` + error.message);
        } finally {
          const btn = document.getElementById(`${action}-contract-btn`);
          if (btn) {
            btn.disabled = false;
            btn.textContent = action === 'approve' ? 'Approve Contract' : 'Reject Contract';
          }
        }
      }
      
      // Handle owner payment confirmation
      async function handleOwnerPaymentConfirmation(contract) {
        try {
          // Check if wallet is connected
          if (!currentAccount) {
            alert('Please connect your MetaMask wallet first to confirm payment.');
            return;
          }

          const confirmed = confirm(`Confirm that you have received payment of $${contract.TotalPrice} CPT for contract ${contract.ContractId}?\n\nThis will create a transaction on the blockchain.`);
          if (!confirmed) return;
          
          const btn = document.getElementById('confirm-payment-received-btn');
          btn.disabled = true;
          btn.textContent = 'Processing on Blockchain...';
          
          try {
            // Create a blockchain transaction for owner confirmation
            const signer = await provider.getSigner();
            
            // Create a simple transaction to record the confirmation on blockchain
            const confirmationTx = await signer.sendTransaction({
              to: currentAccount, // Send to self as a record
              value: ethers.parseEther('0'), // No ETH transfer
              data: ethers.toUtf8Bytes(`CONFIRM_PAYMENT:${contract.ContractId}:${Date.now()}`), // Data payload
              gasLimit: 30000
            });

            console.log('Owner confirmation transaction:', confirmationTx.hash);
            
            // Show transaction pending
            btn.textContent = 'Confirming on Blockchain...';
            
            // Wait for transaction confirmation
            const receipt = await confirmationTx.wait();
            console.log('Confirmation transaction receipt:', receipt);

            // Call backend to update contract status
            const response = await fetch(`${API_BASE_URL}/contracts/${contract.ContractId}/confirm-payment-received`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                ownerId: window.AuthManager.getCurrentUser().UserId,
                ownerWalletAddress: currentAccount,
                confirmationTxHash: confirmationTx.hash,
                gasUsed: receipt.gasUsed.toString(),
                blockNumber: receipt.blockNumber
              })
            });

            const result = await response.json();

            if (result.success) {
              alert(`âœ… Payment confirmation completed successfully!

ðŸ”— Confirmation Transaction: ${confirmationTx.hash}
â›½ Gas Used: ${receipt.gasUsed.toString()}
ðŸ“¦ Block Number: ${receipt.blockNumber}

Contract is now completed and recorded on blockchain.`);
              
              window.contractsManager?.loadContracts();
              updatePaymentSection();
            } else {
              throw new Error(result.error || 'Failed to update contract status');
            }

          } catch (blockchainError) {
            console.error('Blockchain transaction failed:', blockchainError);
            
            if (blockchainError.code === 4001) {
              // User rejected transaction
              alert('Transaction was cancelled by user.');
            } else {
              alert('Blockchain transaction failed: ' + blockchainError.message);
            }
            throw blockchainError;
          }
          
        } catch (error) {
          console.error('Payment confirmation error:', error);
          alert('Failed to confirm payment: ' + error.message);
        } finally {
          const btn = document.getElementById('confirm-payment-received-btn');
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'Confirm Payment Received';
          }
        }
      }
      
      // Listen for account changes
      if (window.ethereum) {
        window.ethereum.on('accountsChanged', async (accounts) => {
          if (accounts.length > 0) {
            const newAccount = accounts[0].toLowerCase();
            const currentUser = AuthManager.getCurrentUser();
            
            if (currentUser) {
              try {
                const response = await fetch(`http://localhost:3000/api/users/${currentUser.UserId}/wallet`);
                const walletData = await response.json();
                
                if (walletData.success && walletData.wallet && walletData.wallet.WalletAddress) {
                  const userWallet = walletData.wallet.WalletAddress.toLowerCase();
                  
                  if (newAccount === userWallet) {
                    currentAccount = accounts[0];
                    await setupWalletConnection();
                    console.log('Account changed to user wallet:', currentAccount);
                  } else {
                    console.log('Account changed to non-user wallet, disconnecting');
                    currentAccount = null;
                    updateWalletUI();
                    updatePaymentSection();
                  }
                } else {
                  // User chÆ°a cÃ³ wallet, disconnect
                  currentAccount = null;
                  updateWalletUI();
                  updatePaymentSection();
                }
              } catch (error) {
                console.error('Error checking account change:', error);
                currentAccount = null;
                updateWalletUI();
                updatePaymentSection();
              }
            }
          } else {
            currentAccount = null;
            updateWalletUI();
            updatePaymentSection();
          }
        });
      }
      
      // Make functions globally accessible
      window.makeContractPayment = makeContractPayment;
      window.connectWallet = connectWallet;
      window.updatePaymentSection = updatePaymentSection;
    </script>
  </body>
</html>