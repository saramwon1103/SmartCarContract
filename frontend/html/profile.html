<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile | Morent</title>
  <link rel="stylesheet" href="../css/admin_dashboard.css" />
  <link rel="stylesheet" href="../css/profile.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <script src="../js/user_sidebar.js"></script>
    <main class="main">
      <header class="topbar">
        <div class="search">
          <input type="text" placeholder="Search..." />
          <span class="filter">
            <img src="../image/search.svg" alt="Search" class="icon" />
          </span>
        </div>
        <div class="user-icons">
          <img id="topAvatar" src="https://i.pravatar.cc/40" alt="avatar" class="avatar" />
        </div>
      </header>
      <section class="content">
        <div class="card">
          <!-- Header chá»©a avatar + icon edit -->
          <div class="profile-header">
            <div class="profile-info-left">
              <img id="profileImage" src="https://i.pravatar.cc/120" alt="Profile" />
              <input type="file" id="upload" style="display:none" accept="image/*" onchange="previewImage(event)" />
            </div>
            <i class="fa-solid fa-pen-to-square edit-icon" id="editBtn" title="Edit Profile"></i>
          </div>
          <form class="profile-form" id="profileForm">
            <div class="form-group">
              <label>Full Name</label>
              <input type="text" id="fullName" readonly />
            </div>
            <div class="form-group">
              <label>Role</label>
              <input type="text" id="role" readonly />
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="email" readonly />
            </div>
            <div class="form-group">
              <label>Wallet Address</label>
              <input type="text" id="wallet" readonly />
            </div>
            <button type="submit" class="save-btn" id="saveBtn" style="display:none">Save Changes</button>
          </form>
        </div>
      </section>
    </main>
  </div>

  <!-- Load required scripts -->
  <script src="../js/auth.js"></script>
  <script src="../js/wallet-auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>

  <script>
    async function loadUserProfile() {
      try {
        // Check authentication first
        if (!AuthManager.isLoggedIn()) {
          alert('Please login to view profile');
          window.location.href = 'login.html';
          return;
        }

        const user = AuthManager.getCurrentUser();
        if (!user) {
          alert('User session not found');
          window.location.href = 'login.html';
          return;
        }

        console.log('Loading profile for user:', user);

        // Get fresh user data from API
        const response = await fetch(`http://localhost:3000/api/auth/me?userId=${user.UserId}`);
        const result = await response.json();

        if (result.success) {
          const userData = result.user;
          
          // Update profile display
          document.getElementById("profileImage").src = userData.AvatarURL || "https://i.pravatar.cc/120";
          document.getElementById("topAvatar").src = userData.AvatarURL || "https://i.pravatar.cc/40";
          document.getElementById("fullName").value = userData.FullName || "";
          document.getElementById("role").value = userData.Role || "";
          document.getElementById("email").value = userData.Email || "";
          document.getElementById("wallet").value = userData.WalletAddress || "";

          // Load wallet information if available
          if (userData.WalletAddress) {
            await loadWalletInfo(user.UserId, userData.WalletAddress);
          }
        } else {
          console.error('API Error:', result.error);
          alert(`Error loading profile: ${result.error}`);
        }
      } catch (error) {
        console.error("Error loading profile:", error);
        alert("Connection error! Please check if the server is running.");
      }
    }

    async function loadWalletInfo(userId, walletAddress) {
      try {
        // Get wallet details
        const walletResponse = await fetch(`http://localhost:3000/api/users/${userId}/wallet`);
        const walletResult = await walletResponse.json();

        if (walletResult.success && walletResult.wallet) {
          console.log('Wallet info:', walletResult.wallet);
          
          // Show additional wallet info if needed
          const walletInfo = document.createElement('div');
          walletInfo.className = 'wallet-info';
          walletInfo.innerHTML = `
            <small>CPT Balance: ${walletResult.wallet.CPTBalance || 0} CPT</small>
          `;
          
          const walletField = document.getElementById("wallet");
          if (walletField.parentNode.querySelector('.wallet-info')) {
            walletField.parentNode.querySelector('.wallet-info').remove();
          }
          walletField.parentNode.appendChild(walletInfo);
        }
      } catch (error) {
        console.error('Error loading wallet info:', error);
      }
    }

    // Initialize page
    window.addEventListener("DOMContentLoaded", function() {
      // Protect page access
      AuthManager.protectPage(['User', 'Owner', 'Admin']);
      
      // Load profile
      loadUserProfile();
      
      // Update header profile info
      AuthManager.updateHeaderProfile();
    });

    // Edit mode
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");
    const inputs = document.querySelectorAll("#profileForm input");

    editBtn.addEventListener("click", () => {
      inputs.forEach(input => {
        if (input.id !== 'role') { // Role should not be editable
          input.removeAttribute("readonly");
        }
      });
      saveBtn.style.display = "block";
    });

    // Save changes
    document.getElementById("profileForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const user = AuthManager.getCurrentUser();
      if (!user) {
        alert('Session expired. Please login again.');
        window.location.href = 'login.html';
        return;
      }

      const updatedData = {
        fullName: document.getElementById("fullName").value,
        email: document.getElementById("email").value,
        walletAddress: document.getElementById("wallet").value
      };

      try {
        // Update user profile (you'll need to implement this endpoint)
        const response = await fetch(`http://localhost:3000/api/users/${user.UserId}/profile`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updatedData)
        });

        const result = await response.json();

        if (result.success) {
          alert("Profile updated successfully!");
          
          // Update localStorage with new data
          const updatedUser = { ...user, ...updatedData };
          AuthManager.setSession(updatedUser);
          
          // Reset form to readonly
          inputs.forEach(input => input.setAttribute("readonly", true));
          saveBtn.style.display = "none";
          
          // Reload profile to get latest data
          await loadUserProfile();
        } else {
          alert("Error: " + result.error);
        }
      } catch (error) {
        console.error("Error updating:", error);
        alert("Connection error!");
      }
    });

    // Preview image
    window.previewImage = function (event) {
      const file = event.target.files[0];
      if (file) {
        const img = document.getElementById("profileImage");
        img.src = URL.createObjectURL(file);
        // TODO: Implement image upload to server
        console.log('Image selected:', file.name);
      }
    };
  </script>
</body>
</html>