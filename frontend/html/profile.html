<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile | Morent</title>
  <link rel="stylesheet" href="../css/admin_dashboard.css" />
  <link rel="stylesheet" href="../css/profile.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <script src="../js/user_sidebar.js"></script>
    <main class="main">
      <header class="topbar">
        <div class="search">
          <input type="text" placeholder="Search..." />
          <span class="filter">
            <img src="../image/search.svg" alt="Search" class="icon" />
          </span>
        </div>
        <div class="user-icons">
          <img id="topAvatar" src="https://i.pravatar.cc/40" alt="avatar" class="avatar" />
        </div>
      </header>
      <section class="content">
        <div class="card">
          <!-- Header chứa avatar + icon edit -->
          <div class="profile-header">
            <div class="profile-info-left">
              <img id="profileImage" src="https://i.pravatar.cc/120" alt="Profile" />
              <input type="file" id="upload" style="display:none" accept="image/*" onchange="previewImage(event)" />
            </div>
            <i class="fa-solid fa-pen-to-square edit-icon" id="editBtn" title="Edit Profile"></i>
          </div>
          <form class="profile-form" id="profileForm">
            <div class="form-group">
              <label>Full Name</label>
              <input type="text" id="fullName" readonly />
            </div>
            <div class="form-group">
              <label>Role</label>
              <input type="text" id="role" readonly />
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="email" readonly />
            </div>
            <div class="form-group">
              <label>Wallet Address</label>
              <input type="text" id="wallet" readonly />
            </div>
            <button type="submit" class="save-btn" id="saveBtn" style="display:none">Save Changes</button>
          </form>
        </div>
      </section>
    </main>
  </div>

  <!-- Thay toàn bộ JS Firebase bằng đoạn này -->
  <script>
    const userId = localStorage.getItem("userId") || "U001"; // Thay bằng login thực tế sau

    async function loadUserProfile() {
      try {
        const response = await fetch(`http://localhost:3000/api/user/${userId}`);
        const result = await response.json();

        if (result.success) {
          const user = result.user;
          document.getElementById("profileImage").src = user.PhotoURL || "https://i.pravatar.cc/120";
          document.getElementById("topAvatar").src = user.PhotoURL || "https://i.pravatar.cc/40";
          document.getElementById("fullName").value = user.FullName || "";
          document.getElementById("role").value = user.Role || "";
          document.getElementById("email").value = user.Email || "";
          document.getElementById("wallet").value = user.WalletAddress || "";
        } else {
          alert("Không tìm thấy người dùng!");
        }
      } catch (error) {
        console.error("Error loading profile:", error);
        alert("Lỗi kết nối server!");
      }
    }

    // Gọi khi load trang
    window.addEventListener("DOMContentLoaded", loadUserProfile);

    // Edit mode
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");
    const inputs = document.querySelectorAll("#profileForm input");

    editBtn.addEventListener("click", () => {
      inputs.forEach(input => input.removeAttribute("readonly"));
      saveBtn.style.display = "block";
    });

    // Save changes
    document.getElementById("profileForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const updatedData = {
        fullName: document.getElementById("fullName").value,
        role: document.getElementById("role").value,
        email: document.getElementById("email").value,
        walletAddress: document.getElementById("wallet").value
      };

      try {
        const response = await fetch(`http://localhost:3000/api/user/${userId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updatedData)
        });

        const result = await response.json();

        if (result.success) {
          alert("Cập nhật thành công!");
          inputs.forEach(input => input.setAttribute("readonly", true));
          saveBtn.style.display = "none";
        } else {
          alert("Lỗi: " + result.error);
        }
      } catch (error) {
        console.error("Error updating:", error);
        alert("Lỗi kết nối!");
      }
    });

    // Preview ảnh
    window.previewImage = function (event) {
      const file = event.target.files[0];
      if (file) {
        const img = document.getElementById("profileImage");
        img.src = URL.createObjectURL(file);
        // TODO: Upload ảnh lên server nếu cần
      }
    };
  </script>
</body>
</html>