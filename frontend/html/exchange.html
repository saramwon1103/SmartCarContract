<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ETH â‡„ CPT Exchange | Morent</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/header.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    .exchange-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      margin-top: 50px;
    }

    .exchange-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .exchange-title {
      font-size: 28px;
      font-weight: 700;
      color: #333;
      margin-bottom: 10px;
    }

    .exchange-subtitle {
      color: #666;
      font-size: 16px;
    }

    .exchange-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .input-group {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .input-group:focus-within {
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .input-label {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 10px;
      font-weight: 600;
      color: #333;
    }

    .balance-info {
      font-size: 14px;
      color: #666;
      margin-left: auto;
    }

    .input-wrapper {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .amount-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-size: 24px;
      font-weight: 600;
      color: #333;
      padding: 10px 0;
    }

    .token-symbol {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      min-width: 80px;
      text-align: center;
    }

    .swap-button {
      align-self: center;
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 20px;
    }

    .swap-button:hover {
      background: #007bff;
      color: white;
      transform: rotate(180deg);
    }

    .exchange-info {
      background: #e3f2fd;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .info-row:last-child {
      margin-bottom: 0;
      font-weight: 600;
      font-size: 16px;
      padding-top: 10px;
      border-top: 1px solid #bbdefb;
    }

    .info-label {
      color: #666;
    }

    .info-value {
      color: #333;
      font-weight: 500;
    }

    .exchange-btn {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      border: none;
      border-radius: 15px;
      padding: 18px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .exchange-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 123, 255, 0.3);
    }

    .exchange-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }

    .wallet-status {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .wallet-status.disconnected {
      background: #f8d7da;
      border-color: #f5c6cb;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #28a745;
    }

    .status-dot.disconnected {
      background: #dc3545;
    }

    .connect-wallet-btn {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .connect-wallet-btn:hover {
      background: #0056b3;
    }

    .max-button {
      background: #17a2b8;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .max-button:hover {
      background: #138496;
    }

    .transaction-status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      display: none;
    }

    .transaction-status.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .transaction-status.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .transaction-status.pending {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .exchange-card {
        margin-top: 20px;
        padding: 20px;
      }
      
      .amount-input {
        font-size: 20px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="exchange-card">
      <!-- Header -->
      <div class="exchange-header">
        <h1 class="exchange-title">ðŸ”„ ETH â‡„ CPT Exchange</h1>
        <p class="exchange-subtitle">Swap your ETH for CarPay Tokens instantly</p>
      </div>

      <!-- Wallet Status -->
      <div class="wallet-status disconnected" id="walletStatus">
        <div class="status-dot disconnected" id="statusDot"></div>
        <span id="walletText">Wallet not connected</span>
        <button class="connect-wallet-btn" id="connectBtn">Connect Wallet</button>
      </div>

      <!-- Exchange Form -->
      <form class="exchange-form" id="exchangeForm">
        <!-- From (ETH) -->
        <div class="input-group">
          <div class="input-label">
            <span>From</span>
            <span class="balance-info">Balance: <span id="ethBalance">0.0000</span> ETH</span>
          </div>
          <div class="input-wrapper">
            <input 
              type="number" 
              class="amount-input" 
              id="ethInput" 
              placeholder="0.0" 
              step="0.0001"
              min="0"
            >
            <button type="button" class="max-button" id="maxButton">MAX</button>
            <div class="token-symbol">ETH</div>
          </div>
        </div>

        <!-- Swap Button -->
        <button type="button" class="swap-button" id="swapButton">â‡…</button>

        <!-- To (CPT) -->
        <div class="input-group">
          <div class="input-label">
            <span>To</span>
            <span class="balance-info">Balance: <span id="cptBalance">0.00</span> CPT</span>
          </div>
          <div class="input-wrapper">
            <input 
              type="number" 
              class="amount-input" 
              id="cptInput" 
              placeholder="0.0" 
              readonly
            >
            <div class="token-symbol">CPT</div>
          </div>
        </div>

        <!-- Exchange Info -->
        <div class="exchange-info">
          <div class="info-row">
            <span class="info-label">Exchange Rate:</span>
            <span class="info-value" id="exchangeRate">1 ETH = 3,484.32 CPT</span>
          </div>
          <div class="info-row">
            <span class="info-label">Token Price:</span>
            <span class="info-value" id="tokenPrice">0.000287 ETH</span>
          </div>
          <div class="info-row">
            <span class="info-label">Network Fee:</span>
            <span class="info-value" id="networkFee">~0.001 ETH</span>
          </div>
          <div class="info-row">
            <span class="info-label">You'll receive:</span>
            <span class="info-value" id="finalAmount">0 CPT</span>
          </div>
        </div>

        <!-- Exchange Button -->
        <button type="submit" class="exchange-btn" id="exchangeBtn" disabled>
          Connect Wallet to Continue
        </button>
      </form>

      <!-- Transaction Status -->
      <div class="transaction-status" id="transactionStatus"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/dist/ethers.umd.js"></script>
  <script>
    // Constants
    const CONTRACT_ADDRESSES = {
      CPT_TOKEN: '0x5FbDB2315678afecb367f032d93F642f64180aa3'
    };
    
    const CPT_ABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function tokenPrice() view returns (uint256)",
      "function buyTokens() payable",
      "function name() view returns (string)",
      "function symbol() view returns (string)",
      "function decimals() view returns (uint8)",
      "event TokensPurchased(address indexed buyer, uint256 ethSpent, uint256 tokensReceived)"
    ];

    // Global variables
    let provider = null;
    let signer = null;
    let currentAccount = null;
    let cptContract = null;
    let ethBalance = 0;
    let cptBalance = 0;
    let tokenPrice = 0.000287; // Default fallback

    // DOM elements
    const connectBtn = document.getElementById('connectBtn');
    const walletStatus = document.getElementById('walletStatus');
    const statusDot = document.getElementById('statusDot');
    const walletText = document.getElementById('walletText');
    const ethInput = document.getElementById('ethInput');
    const cptInput = document.getElementById('cptInput');
    const maxButton = document.getElementById('maxButton');
    const exchangeBtn = document.getElementById('exchangeBtn');
    const exchangeForm = document.getElementById('exchangeForm');
    const transactionStatus = document.getElementById('transactionStatus');

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      connectBtn.addEventListener('click', connectWallet);
      maxButton.addEventListener('click', setMaxETH);
      ethInput.addEventListener('input', calculateCPTAmount);
      exchangeForm.addEventListener('submit', performSwap);
      
      checkWalletConnection();
    });

    // Check if wallet is already connected
    async function checkWalletConnection() {
      if (typeof window.ethereum !== 'undefined') {
        try {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          if (accounts.length > 0) {
            await connectWallet();
          }
        } catch (error) {
          console.error('Error checking wallet connection:', error);
        }
      }
    }

    // Connect wallet
    async function connectWallet() {
      try {
        if (typeof window.ethereum === 'undefined') {
          alert('Please install MetaMask to use this exchange');
          return;
        }

        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        currentAccount = accounts[0];

        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        
        cptContract = new ethers.Contract(CONTRACT_ADDRESSES.CPT_TOKEN, CPT_ABI, signer);

        updateWalletUI();
        await loadBalances();
        await loadTokenPrice();

      } catch (error) {
        console.error('Failed to connect wallet:', error);
        showTransactionStatus('Failed to connect wallet: ' + error.message, 'error');
      }
    }

    // Update wallet UI
    function updateWalletUI() {
      const shortAddress = currentAccount.substring(0, 6) + '...' + currentAccount.substring(38);
      
      walletStatus.classList.remove('disconnected');
      statusDot.classList.remove('disconnected');
      walletText.textContent = `Connected: ${shortAddress}`;
      connectBtn.style.display = 'none';
      
      exchangeBtn.disabled = false;
      exchangeBtn.textContent = 'Enter Amount';
    }

    // Load balances
    async function loadBalances() {
      try {
        // ETH balance
        const ethBalanceWei = await provider.getBalance(currentAccount);
        ethBalance = parseFloat(ethers.formatEther(ethBalanceWei));
        document.getElementById('ethBalance').textContent = ethBalance.toFixed(4);

        // CPT balance
        const cptBalanceWei = await cptContract.balanceOf(currentAccount);
        cptBalance = parseFloat(ethers.formatUnits(cptBalanceWei, 18));
        document.getElementById('cptBalance').textContent = cptBalance.toFixed(2);

      } catch (error) {
        console.error('Error loading balances:', error);
      }
    }

    // Load token price from contract
    async function loadTokenPrice() {
      try {
        const priceWei = await cptContract.tokenPrice();
        tokenPrice = parseFloat(ethers.formatEther(priceWei));
        
        const exchangeRate = (1 / tokenPrice).toFixed(2);
        
        document.getElementById('tokenPrice').textContent = `${tokenPrice.toFixed(6)} ETH`;
        document.getElementById('exchangeRate').textContent = `1 ETH = ${exchangeRate} CPT`;
        
        console.log('Token price loaded:', tokenPrice, 'ETH per CPT');
        
      } catch (error) {
        console.error('Error loading token price:', error);
        // Fallback to default price
        console.log('Using fallback token price:', tokenPrice);
      }
    }

    // Set max ETH amount
    function setMaxETH() {
      const maxAmount = Math.max(0, ethBalance - 0.001); // Leave some ETH for gas
      ethInput.value = maxAmount.toFixed(6);
      calculateCPTAmount();
    }

    // Calculate CPT amount
    function calculateCPTAmount() {
      const ethAmount = parseFloat(ethInput.value) || 0;
      
      if (ethAmount > 0 && tokenPrice > 0) {
        const cptAmount = ethAmount / tokenPrice;
        cptInput.value = cptAmount.toFixed(2);
        
        document.getElementById('finalAmount').textContent = `${cptAmount.toFixed(2)} CPT`;
        
        // Update button
        if (ethAmount > ethBalance) {
          exchangeBtn.disabled = true;
          exchangeBtn.textContent = 'Insufficient ETH Balance';
        } else if (ethAmount <= 0) {
          exchangeBtn.disabled = true;
          exchangeBtn.textContent = 'Enter Amount';
        } else {
          exchangeBtn.disabled = false;
          exchangeBtn.textContent = `Swap ${ethAmount} ETH for ${cptAmount.toFixed(2)} CPT`;
        }
      } else {
        cptInput.value = '';
        document.getElementById('finalAmount').textContent = '0 CPT';
        exchangeBtn.disabled = true;
        exchangeBtn.textContent = 'Enter Amount';
      }
    }

    // Perform swap
    async function performSwap(event) {
      event.preventDefault();
      
      const ethAmount = parseFloat(ethInput.value);
      
      if (!ethAmount || ethAmount <= 0) {
        alert('Please enter a valid ETH amount');
        return;
      }
      
      if (ethAmount > ethBalance) {
        alert('Insufficient ETH balance');
        return;
      }

      try {
        exchangeBtn.disabled = true;
        exchangeBtn.textContent = 'Processing Swap...';
        
        showTransactionStatus('Initiating swap transaction...', 'pending');

        // Convert ETH amount to wei
        const ethAmountWei = ethers.parseEther(ethAmount.toString());
        
        console.log('Buying tokens with:', ethAmount, 'ETH');
        
        // Call buyTokens function
        const tx = await cptContract.buyTokens({
          value: ethAmountWei,
          gasLimit: 100000 // Set reasonable gas limit
        });
        
        showTransactionStatus(
          `Transaction submitted! Hash: ${tx.hash}<br>Waiting for confirmation...`, 
          'pending'
        );

        // Wait for confirmation
        const receipt = await tx.wait();
        
        console.log('Transaction confirmed:', receipt);
        
        // Parse events to get actual tokens received
        let tokensReceived = 0;
        for (const log of receipt.logs) {
          try {
            const decoded = cptContract.interface.parseLog({
              topics: log.topics,
              data: log.data
            });
            
            if (decoded.name === 'TokensPurchased') {
              tokensReceived = parseFloat(ethers.formatUnits(decoded.args.tokensReceived, 18));
              break;
            }
          } catch (error) {
            // Skip unparseable logs
          }
        }

        showTransactionStatus(
          `âœ… Swap successful!<br>
          Received: ${tokensReceived.toFixed(2)} CPT<br>
          Transaction: ${receipt.hash}<br>
          Gas used: ${receipt.gasUsed.toString()}`,
          'success'
        );

        // Reset form and reload balances
        ethInput.value = '';
        cptInput.value = '';
        calculateCPTAmount();
        
        setTimeout(() => {
          loadBalances();
        }, 2000);

      } catch (error) {
        console.error('Swap failed:', error);
        showTransactionStatus(`Swap failed: ${error.message}`, 'error');
      } finally {
        exchangeBtn.disabled = false;
        exchangeBtn.textContent = 'Enter Amount';
      }
    }

    // Show transaction status
    function showTransactionStatus(message, type) {
      transactionStatus.className = `transaction-status ${type}`;
      transactionStatus.innerHTML = message;
      transactionStatus.style.display = 'block';
      
      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          transactionStatus.style.display = 'none';
        }, 10000);
      }
    }

    // Estimate network fee
    async function estimateNetworkFee() {
      try {
        if (provider && cptContract) {
          const gasEstimate = await cptContract.buyTokens.estimateGas({
            value: ethers.parseEther('0.01') // Estimate with 0.01 ETH
          });
          
          const gasPrice = (await provider.getFeeData()).gasPrice;
          const fee = parseFloat(ethers.formatEther(gasEstimate * gasPrice));
          
          document.getElementById('networkFee').textContent = `~${fee.toFixed(6)} ETH`;
        }
      } catch (error) {
        console.log('Could not estimate gas fee');
      }
    }

    // Auto-update network fee when page loads
    setTimeout(estimateNetworkFee, 3000);
  </script>
</body>
</html>